<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SolarOracle MASTER Admin v2.5 - Centro de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Outfit", sans-serif;
        background-color: #f3fcf8;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.02);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .glass-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.04);
        border-color: rgba(16, 185, 129, 0.2);
      }

      .nav-item.active {
        background: #10b981;
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      }

      @keyframes marquee {
        0% {
          transform: translateX(100%);
        }
        100% {
          transform: translateX(-100%);
        }
      }
      .animate-marquee {
        animation: marquee 90s linear infinite;
      }

      .nav-item:not(.active):hover {
        background: #ecfdf5;
        color: #10b981;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }

      .status-ok {
        background: #10b981;
        box-shadow: 0 0 12px rgba(16, 185, 129, 0.5);
      }

      .status-error {
        background: #ef4444;
        box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
      }

      .status-warn {
        background: #f59e0b;
        box-shadow: 0 0 12px rgba(245, 158, 11, 0.5);
      }

      .whale-badge {
        background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
        color: white;
        padding: 2px 10px;
        border-radius: 20px;
        font-size: 0.65rem;
        font-weight: 900;
        letter-spacing: 0.02em;
      }

      .ai-badge {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.6rem;
        font-weight: 800;
        box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4);
      }

      .animate-fade-in {
        animation: fadeIn 0.4s ease-out forwards;
      }
    </style>
  </head>

  <body
    class="text-slate-600 antialiased min-h-screen lg:h-screen flex flex-col lg:flex-row"
  >
    <!-- Login Overlay -->
    <div
      id="login-overlay"
      class="fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-white/95 backdrop-blur-2xl"
    >
      <div class="glass-card p-10 w-full max-w-md text-center">
        <div class="mb-6">
          <img
            src="isotipo_solaroracle_v3.png"
            alt="SolarOracle"
            class="w-16 h-16 mx-auto object-contain"
          />
        </div>
        <h2 class="text-2xl font-black text-slate-800 mb-2">
          Acceso Restringido
        </h2>
        <p class="text-slate-400 text-sm mb-8 font-medium">
          SolarOracle Admin Dashboard V2
        </p>

        <div class="relative mb-6">
          <input
            type="password"
            id="admin-pass"
            placeholder="Contrase√±a Maestra"
            class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition-all font-bold tracking-widest text-center"
            onkeypress="if (event.key === 'Enter') checkPass();"
          />
          <svg
            class="w-6 h-6 text-slate-300 absolute left-4 top-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 00-2 2zm10-10V7a4 4 0 00-8 0v4h8z"
            />
          </svg>
        </div>

        <button
          onclick="checkPass()"
          class="w-full py-4 bg-emerald-500 text-white rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-emerald-600 transition shadow-xl shadow-emerald-100 mb-4"
        >
          Verificar Identidad
        </button>
        <p
          id="pass-error"
          class="hidden text-red-500 text-xs font-bold animate-bounce mt-2"
        >
          Acceso Denegado: Contrase√±a Incorrecta
        </p>
      </div>
    </div>

    <!-- Mobile Header -->
    <div
      class="lg:hidden bg-white border-b border-slate-100 p-4 flex items-center justify-between sticky top-0 z-50"
    >
      <div class="flex items-center gap-3">
        <img
          src="logo_solaroracle_v3.png"
          alt="SolarOracle"
          class="h-8 w-auto object-contain"
        />
      </div>
      <button
        onclick="toggleMobileMenu()"
        class="p-2 text-slate-500 hover:bg-slate-50 rounded-xl transition"
      >
        <svg
          id="menu-icon"
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16m-7 6h7"
          />
        </svg>
      </button>
    </div>

    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="fixed inset-y-0 left-0 w-72 bg-white border-r border-slate-100 flex-shrink-0 flex flex-col h-full z-40 transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300 ease-in-out"
    >
      <div class="p-8 pb-4 hidden lg:flex items-center justify-start">
        <img
          src="logo_solaroracle_v3.png"
          alt="SolarOracle"
          class="h-12 w-auto object-contain"
        />
      </div>

      <nav class="flex-1 px-4 py-8 space-y-2 overflow-y-auto">
        <p
          class="px-4 text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-4"
        >
          Operativa B2B
        </p>

        <!-- NAV: Motor Oracle IA -->
        <button
          onclick="showSection('oracle')"
          id="nav-oracle"
          class="nav-item active w-full flex items-center gap-3 px-6 py-4 rounded-2xl transition-all duration-300"
        >
          <span class="text-lg">üëÅÔ∏è</span>
          <span class="font-bold text-sm tracking-tight">Motor Oracle IA</span>
          <span
            class="ml-auto bg-emerald-100 text-emerald-600 py-0.5 px-2.5 rounded-lg text-[10px] font-black"
            id="sidebar-oracle-count"
            >0</span
          >
        </button>
      </nav>

      <div class="mt-auto p-4 border-t border-slate-50">
        <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest text-center">
          SolarOracle IA ¬∑ 2026
        </p>
      </div>
    </aside>

    <!-- Mobile Overlay -->
    <div
      id="overlay"
      onclick="toggleMobileMenu()"
      class="fixed inset-0 bg-slate-900/40 z-30 hidden transition-opacity duration-300"
    ></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
      <!-- Header / Stats Bar -->
      <header
        class="h-20 hidden lg:flex items-center justify-between px-10 bg-white/50 backdrop-blur-md z-20 sticky top-0 border-b border-slate-100"
      >
        <div>
          <p
            class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]"
            id="header-subtitle"
          >
            Panel Central
          </p>
          <h2 class="text-xl font-black text-slate-800" id="header-title">
            Admin Dashboard <span class="ml-2 text-[10px] bg-emerald-500 text-white px-2 py-1 rounded-full animate-pulse">V3.0 FIXED</span>
          </h2>
        </div>

        <div class="flex items-center gap-6">
          <div
            class="flex items-center gap-3 bg-white px-5 py-2.5 rounded-2xl border border-slate-100 shadow-sm"
          >
            <svg
              class="w-4 h-4 text-emerald-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <span class="text-xs font-bold text-slate-600" id="current-date"
              >Cargando fecha...</span
            >
          </div>

          <button
            class="w-10 h-10 rounded-xl bg-white border border-slate-100 flex items-center justify-center text-slate-400 hover:text-emerald-500 hover:border-emerald-200 transition shadow-sm relative"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
              />
            </svg>
            <span
              class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-white"
            ></span>
          </button>
        </div>
      </header>

      <!-- Scrollable Area -->
      <div class="flex-1 overflow-y-auto p-4 lg:p-10" id="main-scroll">
        <!-- ============================================================ -->
        <!-- SECTION: MOTOR ORACLE IA                                      -->
        <!-- ============================================================ -->
        <section id="oracle-section" class="animate-fade-in hidden">
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- #1 HERO BANNER ‚Äî CEREBRO VIVO                           -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div
            id="oracle-hero"
            class="relative overflow-hidden rounded-3xl mb-8 pt-8 px-8 pb-14"
            style="
              background: linear-gradient(
                135deg,
                #0f0c29 0%,
                #302b63 50%,
                #24243e 100%
              );
              min-height: 180px;
            "
          >
            <!-- Animated particles canvas -->
            <canvas
              id="oracle-particles-canvas"
              class="absolute inset-0 w-full h-full opacity-40"
              style="pointer-events: none"
            ></canvas>

            <!-- Scan button top-right -->
            <div class="absolute top-5 right-5 flex gap-2 z-10">
              <button
                onclick="loadOracleData()"
                class="flex items-center gap-1.5 px-4 py-2 rounded-xl font-bold text-xs transition"
                style="
                  background: rgba(255, 255, 255, 0.1);
                  color: rgba(255, 255, 255, 0.7);
                  border: 1px solid rgba(255, 255, 255, 0.15);
                  backdrop-filter: blur(8px);
                "
              >
                üîÑ Actualizar
              </button>
              <button
                onclick="forceScan()"
                id="oracle-scan-btn"
                class="flex items-center gap-1.5 px-4 py-2 rounded-xl font-bold text-xs transition"
                style="
                  background: linear-gradient(135deg, #7c3aed, #a855f7);
                  color: white;
                  box-shadow: 0 4px 20px rgba(124, 58, 237, 0.5);
                "
              >
                <span id="oracle-scan-icon">‚ö°</span>
                <span id="oracle-scan-label">Escaneo Manual</span>
              </button>
            </div>

            <!-- Content -->
            <div class="relative z-10 flex items-center gap-6">
              <!-- Brain pulse -->
              <div class="relative flex-shrink-0">
                <div
                  class="w-16 h-16 rounded-2xl flex items-center justify-center text-3xl"
                  style="
                    background: rgba(124, 58, 237, 0.3);
                    border: 1px solid rgba(167, 139, 250, 0.3);
                  "
                >
                  üß†
                </div>
                <span
                  class="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-emerald-400 animate-pulse border-2 border-white"
                ></span>
              </div>
              <div>
                <div class="flex items-center gap-3 mb-1">
                  <h2 class="text-2xl font-black text-white tracking-tight">
                    ORACLE BRAIN
                  </h2>
                  <span
                    class="px-2.5 py-0.5 rounded-full text-[10px] font-black tracking-widest"
                    style="
                      background: rgba(52, 211, 153, 0.2);
                      color: #34d399;
                      border: 1px solid rgba(52, 211, 153, 0.3);
                    "
                    >‚óè ACTIVO</span
                  >
                </div>
                <p class="text-sm mb-3" style="color: rgba(255, 255, 255, 0.5)">
                  Agente aut√≥nomo de inteligencia de mercado solar ¬∑ Chile
                </p>
                <div class="flex flex-wrap gap-4">
                  <div class="flex items-center gap-2">
                    <span
                      class="text-xs font-bold"
                      style="color: rgba(255, 255, 255, 0.4)"
                      >√öLTIMO ESCANEO</span
                    >
                    <span
                      class="text-xs font-black text-violet-300"
                      id="oracle-hero-last-scan"
                      >‚Äî</span
                    >
                  </div>
                  <div class="flex items-center gap-2">
                    <span
                      class="text-xs font-bold"
                      style="color: rgba(255, 255, 255, 0.4)"
                      >PR√ìXIMO</span
                    >
                    <span class="text-xs font-black text-emerald-300"
                      >08:00 AM</span
                    >
                  </div>
                  <div class="flex items-center gap-2">
                    <span
                      class="text-xs font-bold"
                      style="color: rgba(255, 255, 255, 0.4)"
                      >COBERTURA</span
                    >
                    <span class="text-xs font-black text-amber-300"
                      >üá®üá± Chile completo</span
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- Integrated Live Feed (Bottom Bar) -->
            <div
              class="absolute bottom-0 left-0 right-0 bg-slate-900/60 backdrop-blur-md border-t border-white/10 py-2 px-6 flex items-center gap-4 z-20"
            >
              <span
                class="text-[9px] font-black tracking-widest text-emerald-400 animate-pulse flex-shrink-0"
                >‚óè LIVE FEED</span
              >
              <div class="flex-1 overflow-hidden relative h-4">
                <div
                  id="oracle-feed-track"
                  class="absolute whitespace-nowrap text-[10px] font-mono text-slate-300 flex gap-12 animate-marquee leading-4"
                >
                  <!-- JS will inject items here -->
                  <span>Iniciando monitoreo de mercado...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- #2 KPI CARDS CON SPARKLINES + CONTEO ANIMADO            -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- KPI: Total Leads -->
            <div
              class="glass-card p-5 relative overflow-hidden group hover:shadow-lg transition-all duration-300"
            >
              <div
                class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                style="
                  background: linear-gradient(
                    135deg,
                    rgba(124, 58, 237, 0.04),
                    transparent
                  );
                "
              ></div>
              <div class="flex items-start justify-between mb-3">
                <div
                  class="w-9 h-9 rounded-xl flex items-center justify-center text-lg"
                  style="
                    background: linear-gradient(135deg, #7c3aed22, #a855f722);
                  "
                >
                  üè¢
                </div>
                <span
                  class="text-[9px] font-black px-2 py-0.5 rounded-full"
                  style="background: #f3f0ff; color: #7c3aed"
                  id="oracle-kpi-total-trend"
                  >‚Äî</span
                >
              </div>
              <p
                class="text-3xl font-black text-violet-600 tabular-nums"
                id="oracle-kpi-total"
              >
                ‚Äî
              </p>
              <p
                class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1"
              >
                Leads B2B Totales
              </p>
              <p class="text-[10px] text-slate-300 mt-0.5">
                Empresas instaladoras
              </p>
              <canvas
                id="spark-total"
                class="w-full mt-3"
                height="28"
                style="opacity: 0.6"
              ></canvas>
            </div>

            <!-- KPI: Hoy -->
            <div
              class="glass-card p-5 relative overflow-hidden group hover:shadow-lg transition-all duration-300"
            >
              <div
                class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                style="
                  background: linear-gradient(
                    135deg,
                    rgba(16, 185, 129, 0.04),
                    transparent
                  );
                "
              ></div>
              <div class="flex items-start justify-between mb-3">
                <div
                  class="w-9 h-9 rounded-xl flex items-center justify-center text-lg"
                  style="
                    background: linear-gradient(135deg, #10b98122, #34d39922);
                  "
                >
                  üì°
                </div>
                <span
                  class="text-[9px] font-black px-2 py-0.5 rounded-full"
                  style="background: #ecfdf5; color: #059669"
                  id="oracle-kpi-today-trend"
                  >HOY</span
                >
              </div>
              <p
                class="text-3xl font-black text-emerald-600 tabular-nums"
                id="oracle-kpi-today"
              >
                ‚Äî
              </p>
              <p
                class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1"
              >
                Detectados Hoy
              </p>
              <p class="text-[10px] text-slate-300 mt-0.5">Nuevos en 24h</p>
              <canvas
                id="spark-today"
                class="w-full mt-3"
                height="28"
                style="opacity: 0.6"
              ></canvas>
            </div>

            <!-- KPI: Score -->
            <div
              class="glass-card p-5 relative overflow-hidden group hover:shadow-lg transition-all duration-300"
            >
              <div
                class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                style="
                  background: linear-gradient(
                    135deg,
                    rgba(245, 158, 11, 0.04),
                    transparent
                  );
                "
              ></div>
              <div class="flex items-start justify-between mb-3">
                <div
                  class="w-9 h-9 rounded-xl flex items-center justify-center text-lg"
                  style="
                    background: linear-gradient(135deg, #f59e0b22, #fbbf2422);
                  "
                >
                  ‚≠ê
                </div>
                <span
                  class="text-[9px] font-black px-2 py-0.5 rounded-full"
                  style="background: #fffbeb; color: #d97706"
                  id="oracle-kpi-score-trend"
                  >‚Äî</span
                >
              </div>
              <p
                class="text-3xl font-black text-amber-500 tabular-nums"
                id="oracle-kpi-score"
              >
                ‚Äî
              </p>
              <p
                class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1"
              >
                Score Promedio
              </p>
              <p class="text-[10px] text-slate-300 mt-0.5">Calidad de leads</p>
              <canvas
                id="spark-score"
                class="w-full mt-3"
                height="28"
                style="opacity: 0.6"
              ></canvas>
            </div>

            <!-- KPI: Cambios Tarifas -->
            <div
              class="glass-card p-5 relative overflow-hidden group hover:shadow-lg transition-all duration-300"
            >
              <div
                class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                style="
                  background: linear-gradient(
                    135deg,
                    rgba(239, 68, 68, 0.04),
                    transparent
                  );
                "
              ></div>
              <div class="flex items-start justify-between mb-3">
                <div
                  class="w-9 h-9 rounded-xl flex items-center justify-center text-lg"
                  style="
                    background: linear-gradient(135deg, #ef444422, #f8717122);
                  "
                >
                  ‚ö°
                </div>
                <span
                  class="text-[9px] font-black px-2 py-0.5 rounded-full"
                  style="background: #fef2f2; color: #dc2626"
                  id="oracle-kpi-changes-trend"
                  >ALERTAS</span
                >
              </div>
              <p
                class="text-3xl font-black text-red-500 tabular-nums"
                id="oracle-kpi-changes"
              >
                ‚Äî
              </p>
              <p
                class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1"
              >
                Cambios Tarifas
              </p>
              <p class="text-[10px] text-slate-300 mt-0.5">
                Distribuidoras alertadas
              </p>
              <canvas
                id="spark-changes"
                class="w-full mt-3"
                height="28"
                style="opacity: 0.6"
              ></canvas>
            </div>
          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ROW: ALERTAS + TERM√ìMETRO + LEADERBOARD                 -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- #9 ALERTAS INTELIGENTES -->
            <div class="glass-card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-slate-700 flex items-center gap-2">
                  üîî Alertas Oracle
                </h3>
                <span
                  class="text-[9px] font-black px-2 py-0.5 rounded-full bg-red-50 text-red-500"
                  id="oracle-alerts-badge"
                  >‚Äî</span
                >
              </div>
              <div id="oracle-alerts-list" class="space-y-2.5">
                <div class="text-center py-6 text-slate-300 text-sm">
                  Calculando...
                </div>
              </div>
            </div>

            <!-- #12 TERM√ìMETRO DE MERCADO -->
            <div
              class="glass-card p-6 flex flex-col items-center justify-center"
            >
              <h3 class="font-black text-slate-700 mb-4 self-start">
                üå°Ô∏è Temperatura de Mercado
              </h3>
              <!-- Thermometer visual -->
              <div class="relative flex flex-col items-center gap-2 w-full">
                <!-- Scale labels -->
                <div
                  class="flex justify-between w-full text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1"
                >
                  <span>‚ùÑÔ∏è Fr√≠o</span>
                  <span>üå§Ô∏è Tibio</span>
                  <span>‚òÄÔ∏è Caliente</span>
                  <span>üî•</span>
                </div>
                <!-- Bar track -->
                <div
                  class="w-full h-5 rounded-full relative overflow-hidden"
                  style="background: #f1f5f9"
                >
                  <div
                    id="oracle-thermo-bar"
                    class="h-full rounded-full transition-all duration-1000"
                    style="
                      width: 0%;
                      background: linear-gradient(
                        90deg,
                        #60a5fa,
                        #34d399,
                        #fbbf24,
                        #f87171
                      );
                    "
                  ></div>
                  <!-- Needle -->
                  <div
                    id="oracle-thermo-needle"
                    class="absolute top-0 bottom-0 w-0.5 bg-slate-800 rounded-full transition-all duration-1000"
                    style="left: 0%"
                  ></div>
                </div>
                <!-- Value display -->
                <div class="mt-3 text-center">
                  <p class="text-4xl font-black" id="oracle-thermo-emoji">‚è≥</p>
                  <p
                    class="text-sm font-black text-slate-700 mt-1"
                    id="oracle-thermo-label"
                  >
                    Calculando...
                  </p>
                  <p
                    class="text-[10px] text-slate-400 mt-1"
                    id="oracle-thermo-desc"
                  >
                    Analizando se√±ales de mercado
                  </p>
                </div>
              </div>
            </div>

            <!-- #4 LEADERBOARD TOP 10 -->
            <div class="glass-card p-6">
              <h3
                class="font-black text-slate-700 mb-4 flex items-center gap-2"
              >
                üèÜ Top Leads
              </h3>
              <div id="oracle-leaderboard" class="space-y-2">
                <div class="text-center py-6 text-slate-300 text-sm">
                  Cargando ranking...
                </div>
              </div>
            </div>
          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ROW: DISTRIBUIDORAS + TABLA LEADS                       -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- TABS: LISTA / PIPELINE / EVOLUCI√ìN / INSIGHTS           -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- TABS: LISTA / DISTRIBUIDORES / PIPELINE / EVOLUCI√ìN / INSIGHTS -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div class="mb-6 flex gap-2 overflow-x-auto pb-1">
            <button
              onclick="switchOracleTab('list')"
              id="tab-oracle-list"
              class="px-5 py-2 rounded-xl text-xs font-black bg-violet-600 text-white shadow-lg shadow-violet-200 transition"
            >
              üè¢ Lista de Leads
            </button>
            <button
              onclick="switchOracleTab('distributors')"
              id="tab-oracle-distributors"
              class="px-5 py-2 rounded-xl text-xs font-bold bg-white text-slate-500 hover:bg-slate-50 border border-slate-200 transition"
            >
              ‚ö° Distribuidores
            </button>
            <button
              onclick="switchOracleTab('pipeline')"
              id="tab-oracle-pipeline"
              class="px-5 py-2 rounded-xl text-xs font-bold bg-white text-slate-500 hover:bg-slate-50 border border-slate-200 transition"
            >
              üìã Pipeline CRM
            </button>
            <button
              onclick="switchOracleTab('analytics')"
              id="tab-oracle-analytics"
              class="px-5 py-2 rounded-xl text-xs font-bold bg-white text-slate-500 hover:bg-slate-50 border border-slate-200 transition"
            >
              üìà Evoluci√≥n Temporal
            </button>
            <button
              onclick="switchOracleTab('network')"
              id="tab-oracle-network"
              class="px-5 py-2 rounded-xl text-xs font-bold bg-white text-slate-500 hover:bg-slate-50 border border-slate-200 transition"
            >
              üï∏Ô∏è Red Solar
            </button>
            <button
              onclick="switchOracleTab('leaderboard')"
              id="tab-oracle-leaderboard"
              class="px-5 py-2 rounded-xl text-xs font-bold bg-white text-slate-500 hover:bg-slate-100 border border-slate-200 transition whitespace-nowrap"
            >
              üéØ Ranking Regional
            </button>
          </div>

          <!-- VIEW 6: LEADERBOARD REGIONAL -->
          <div id="view-oracle-leaderboard" class="mb-8 hidden">
            <div class="glass-card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-slate-700 flex items-center gap-2">
                  üéØ Ranking de Instaladores por Regi√≥n
                </h3>
              </div>
              <div
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
                id="leaderboard-grid"
              >
                <!-- Data injected here -->
              </div>
            </div>
          </div>

          <!-- VIEW 1: LEADS LIST -->
          <div id="view-oracle-list" class="mb-8 animate-fade-in">
            <div class="glass-card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-slate-700 flex items-center gap-2">
                  üè¢ Leads B2B Detectados
                </h3>
                <select
                  id="oracle-leads-filter"
                  onchange="filterOracleLeads()"
                  class="text-xs border border-slate-200 rounded-xl px-3 py-2 font-semibold text-slate-600"
                >
                  <option value="all">Todos</option>
                  <option value="Nuevo">Nuevos</option>
                  <option value="Revisado">Revisados</option>
                  <option value="Contactado">Contactados</option>
                </select>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="border-b border-slate-100">
                      <th
                        class="text-left py-3 px-2 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                      >
                        Empresa
                      </th>
                      <th
                        class="text-left py-3 px-2 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                      >
                        Score
                      </th>
                      <th
                        class="text-left py-3 px-2 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                      >
                        Ciudad
                      </th>
                      <th
                        class="text-left py-3 px-2 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                      >
                        Fecha
                      </th>
                      <th
                        class="text-left py-3 px-2 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                      >
                        Estado
                      </th>
                      <th
                        class="text-left py-3 px-2 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                      >
                        Acci√≥n
                      </th>
                    </tr>
                  </thead>
                  <tbody id="oracle-leads-tbody">
                    <tr>
                      <td colspan="5" class="text-center py-8 text-slate-300">
                        Cargando leads...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- VIEW 2: DISTRIBUTORS (NEW TAB) -->
          <div
            id="view-oracle-distributors"
            class="hidden animate-fade-in mb-8"
          >
            <div class="glass-card p-6">
              <h3
                class="font-black text-slate-700 mb-4 flex items-center gap-2"
              >
                ‚ö° Estado Distribuidoras de Energ√≠a (CEN)
              </h3>
              <p class="text-xs text-slate-400 mb-6">
                Monitoreo en tiempo real de tarifas BT1 y cambios regulatorios.
              </p>
              <div
                id="oracle-distributors-list"
                class="space-y-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
              >
                <div
                  class="text-center py-8 text-slate-300 text-sm col-span-full"
                >
                  Cargando...
                </div>
              </div>
            </div>
          </div>

          <!-- VIEW 3: CRM PIPELINE (#11) -->
          <div
            id="view-oracle-pipeline"
            class="hidden animate-fade-in mb-8 overflow-x-auto"
          >
            <div class="flex gap-6 min-w-[1000px] pb-4">
              <!-- Column: Nuevos -->
              <div
                class="flex-1 min-w-[300px] bg-slate-50/50 rounded-2xl p-4 border border-slate-100"
              >
                <div class="flex items-center justify-between mb-4">
                  <h4
                    class="font-black text-slate-600 text-xs uppercase tracking-widest"
                  >
                    ‚ú® Nuevos
                  </h4>
                  <span
                    class="bg-violet-100 text-violet-700 text-[10px] font-black px-2 py-0.5 rounded-full"
                    id="count-pipeline-Nuevo"
                    >0</span
                  >
                </div>
                <div
                  id="pipeline-col-Nuevo"
                  class="space-y-3 min-h-[200px]"
                ></div>
              </div>
              <!-- Column: Revisados -->
              <div
                class="flex-1 min-w-[300px] bg-slate-50/50 rounded-2xl p-4 border border-slate-100"
              >
                <div class="flex items-center justify-between mb-4">
                  <h4
                    class="font-black text-slate-600 text-xs uppercase tracking-widest"
                  >
                    üëÄ Revisados
                  </h4>
                  <span
                    class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-0.5 rounded-full"
                    id="count-pipeline-Revisado"
                    >0</span
                  >
                </div>
                <div
                  id="pipeline-col-Revisado"
                  class="space-y-3 min-h-[200px]"
                ></div>
              </div>
              <!-- Column: Contactados -->
              <div
                class="flex-1 min-w-[300px] bg-slate-50/50 rounded-2xl p-4 border border-slate-100"
              >
                <div class="flex items-center justify-between mb-4">
                  <h4
                    class="font-black text-slate-600 text-xs uppercase tracking-widest"
                  >
                    üìû Contactados
                  </h4>
                  <span
                    class="bg-emerald-100 text-emerald-700 text-[10px] font-black px-2 py-0.5 rounded-full"
                    id="count-pipeline-Contactado"
                    >0</span
                  >
                </div>
                <div
                  id="pipeline-col-Contactado"
                  class="space-y-3 min-h-[200px]"
                ></div>
              </div>
            </div>
          </div>

          <!-- VIEW 4: ANALYTICS (#8) -->
          <div
            id="view-oracle-analytics"
            class="hidden animate-fade-in mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6"
          >
            <div class="glass-card p-6">
              <h3 class="font-black text-slate-700 mb-4">
                üìÖ Leads Detectados (30 d√≠as)
              </h3>
              <div class="h-64 relative">
                <canvas id="chart-leads-timeline"></canvas>
              </div>
            </div>
            <div class="glass-card p-6">
              <h3 class="font-black text-slate-700 mb-4">
                ‚≠ê Distribuci√≥n de Calidad
              </h3>
              <div class="h-64 relative">
                <canvas id="chart-scores-dist"></canvas>
              </div>
            </div>
          </div>

          <!-- VIEW 5: NETWORK GRAPH (#3 & #6) -->
          <!-- VIEW 5: NETWORK GRAPH (#3 & #6) -->
          <div
            id="view-oracle-network"
            class="hidden animate-fade-in mb-8 h-[600px] glass-card relative overflow-hidden flex flex-col"
          >
            <div
              class="absolute top-4 left-4 z-[500] bg-slate-900/90 backdrop-blur rounded-xl p-3 border border-slate-700 shadow-lg"
            >
              <h4
                class="text-xs font-black text-white uppercase tracking-widest mb-1"
              >
                Red Solar Satelital
              </h4>
              <p class="text-[10px] text-slate-400">
                Visualizaci√≥n Geo-Espacial de Leads
              </p>
              <div class="mt-2 flex flex-col gap-1.5 text-[9px] font-bold">
                <span class="flex items-center gap-1.5 text-indigo-400"
                  ><span
                    class="w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.5)]"
                  ></span>
                  Distribuidora (CGE/Enel)</span
                >
                <span class="flex items-center gap-1.5 text-emerald-400"
                  ><span
                    class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"
                  ></span>
                  Alta Prioridad (>70)</span
                >
                <span class="flex items-center gap-1.5 text-amber-400"
                  ><span class="w-2 h-2 rounded-full bg-amber-500"></span> Media
                  (40-70)</span
                >
                <span class="flex items-center gap-1.5 text-slate-400"
                  ><span class="w-2 h-2 rounded-full bg-slate-500"></span> Baja
                  / Nuevo</span
                >
              </div>
            </div>
            <div id="oracle-map" class="w-full h-full z-0 bg-slate-900"></div>
          </div>

          <!-- #7 SCORE BREAKDOWN MODAL -->
          <div
            id="oracle-lead-modal"
            class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in"
          >
            <div
              class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden relative"
            >
              <button
                onclick="closeOracleModal()"
                class="absolute top-4 right-4 p-2 hover:bg-slate-100 rounded-full text-slate-400"
              >
                ‚úï
              </button>

              <!-- Modal Header -->
              <div class="p-8 bg-slate-50 border-b border-slate-100">
                <div class="flex items-start gap-4">
                  <div
                    class="w-16 h-16 rounded-2xl bg-violet-100 text-violet-600 flex items-center justify-center text-3xl shadow-inner"
                  >
                    üè¢
                  </div>
                  <div>
                    <h2
                      class="text-2xl font-black text-slate-800"
                      id="modal-lead-name"
                    >
                      Empresa Solar
                    </h2>
                    <p class="text-slate-500 text-sm mt-1" id="modal-lead-meta">
                      Santiago ¬∑ Detectado hace 2h
                    </p>
                    <a
                      href="#"
                      target="_blank"
                      id="modal-lead-link"
                      class="text-xs font-bold text-violet-600 hover:underline mt-2 inline-block"
                      >Visitar Sitio Web ‚Üí</a
                    >
                  </div>
                  <div class="ml-auto text-right">
                    <div
                      class="text-4xl font-black text-emerald-500"
                      id="modal-lead-score"
                    >
                      85
                    </div>
                    <div
                      class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
                    >
                      Oracle Score
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modal Body -->
              <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Breakdown -->
                <div>
                  <h4
                    class="font-black text-slate-700 text-xs uppercase tracking-widest mb-4"
                  >
                    Desglose de Puntaje
                  </h4>
                  <div class="space-y-4">
                    <div>
                      <div
                        class="flex justify-between text-xs font-bold text-slate-600 mb-1"
                      >
                        <span>Sitio Web & SEO</span> <span>25/25</span>
                      </div>
                      <div class="w-full bg-slate-100 rounded-full h-2">
                        <div
                          class="bg-violet-500 h-2 rounded-full"
                          style="width: 100%"
                        ></div>
                      </div>
                    </div>
                    <div>
                      <div
                        class="flex justify-between text-xs font-bold text-slate-600 mb-1"
                      >
                        <span>Coincidencia Keywords</span> <span>20/30</span>
                      </div>
                      <div class="w-full bg-slate-100 rounded-full h-2">
                        <div
                          class="bg-violet-500 h-2 rounded-full"
                          style="width: 66%"
                        ></div>
                      </div>
                    </div>
                    <div>
                      <div
                        class="flex justify-between text-xs font-bold text-slate-600 mb-1"
                      >
                        <span>Ubicaci√≥n Estrat√©gica</span> <span>15/20</span>
                      </div>
                      <div class="w-full bg-slate-100 rounded-full h-2">
                        <div
                          class="bg-violet-500 h-2 rounded-full"
                          style="width: 75%"
                        ></div>
                      </div>
                    </div>
                    <div>
                      <div
                        class="flex justify-between text-xs font-bold text-slate-600 mb-1"
                      >
                        <span>Tama√±o Empresa</span> <span>10/25</span>
                      </div>
                      <div class="w-full bg-slate-100 rounded-full h-2">
                        <div
                          class="bg-violet-500 h-2 rounded-full"
                          style="width: 40%"
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- AI Recommendation -->
                <div>
                  <h4
                    class="font-black text-slate-700 text-xs uppercase tracking-widest mb-4"
                  >
                    An√°lisis de Gemini
                  </h4>
                  <div
                    class="bg-amber-50 border border-amber-100 rounded-xl p-4"
                  >
                    <p class="text-xs text-amber-800 italic leading-relaxed">
                      "Esta empresa muestra una fuerte presencia digital en el
                      sector residencial. Aunque es peque√±a, su ubicaci√≥n en
                      zona de alta radiaci√≥n la convierte en un candidato ideal
                      para nuestra oferta de monitoreo."
                    </p>
                  </div>
                  <div class="mt-6">
                    <button
                      class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-sm hover:bg-slate-800 transition shadow-lg"
                    >
                      ‚ú® Generar Email de Contacto
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Scan Log -->
          <div class="glass-card p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-black text-slate-700 flex items-center gap-2">
                üìã Historial de Escaneos
              </h3>
              <button
                onclick="clearOracleLogs()"
                class="text-[10px] font-black text-slate-400 hover:text-red-500 uppercase tracking-widest transition flex items-center gap-1"
              >
                üóëÔ∏è Limpiar Historial
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-slate-100">
                    <th
                      class="text-left py-3 px-3 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                    >
                      Fecha
                    </th>
                    <th
                      class="text-left py-3 px-3 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                    >
                      Tipo
                    </th>
                    <th
                      class="text-left py-3 px-3 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                    >
                      Estado
                    </th>
                    <th
                      class="text-left py-3 px-3 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                    >
                      Leads Nuevos
                    </th>
                    <th
                      class="text-left py-3 px-3 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                    >
                      Cambios Dist.
                    </th>
                    <th
                      class="text-left py-3 px-3 text-[10px] font-black text-slate-400 uppercase tracking-wider"
                    >
                      Duraci√≥n
                    </th>
                  </tr>
                </thead>
                <tbody id="oracle-log-tbody">
                  <tr>
                    <td colspan="6" class="text-center py-8 text-slate-300">
                      Sin escaneos registrados a√∫n.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- #13 LEAD INTELLIGENCE CARD (SLIDE-OVER) -->
        <div
          id="lead-card-overlay"
          onclick="closeLeadCard()"
          class="hidden fixed inset-0 z-[2000] bg-slate-900/40 backdrop-blur-sm transition-opacity duration-300 opacity-0"
        ></div>

        <div
          id="lead-card-panel"
          class="fixed top-0 right-0 h-full w-full max-w-2xl bg-white shadow-2xl z-[2001] transform translate-x-full transition-transform duration-300 ease-out overflow-y-auto"
        >
          <!-- Header -->
          <div
            class="bg-slate-50 border-b border-slate-100 p-8 pt-12 pb-8 sticky top-0 z-10"
          >
            <button
              onclick="closeLeadCard()"
              class="absolute top-4 left-4 p-2 hover:bg-slate-200 rounded-full text-slate-400 transition"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>

            <div class="flex items-start justify-between">
              <div class="flex items-center gap-4">
                <div
                  class="w-16 h-16 bg-white rounded-2xl shadow-lg border border-slate-100 flex items-center justify-center text-3xl"
                >
                  üè¢
                </div>
                <div>
                  <h2
                    class="text-2xl font-black text-slate-800 leading-tight"
                    id="card-lead-name"
                  >
                    Empresa Solar
                  </h2>
                  <a
                    href="#"
                    target="_blank"
                    id="card-lead-site"
                    class="text-sm font-bold text-violet-600 hover:underline flex items-center gap-1 mt-1"
                  >
                    solar-energy.cl
                    <svg
                      class="w-3 h-3"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                      />
                    </svg>
                  </a>
                </div>
              </div>
              <div class="text-right">
                <div class="flex flex-col items-end">
                  <span
                    class="text-4xl font-black text-emerald-500"
                    id="card-lead-score"
                    >85</span
                  >
                  <span
                    class="text-[10px] font-black text-slate-400 uppercase tracking-widest"
                    >Oracle Score</span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Body -->
          <div class="p-8 space-y-8">
            <!-- Section A: Contact Data -->
            <div>
              <h3
                class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"
              >
                <span class="w-2 h-2 rounded-full bg-slate-300"></span> Datos de
                Contacto
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div
                  class="p-3 bg-slate-50 rounded-xl border border-slate-100 group hover:bg-white hover:border-violet-200 transition-colors"
                >
                  <span
                    class="block text-[10px] uppercase text-slate-400 font-bold mb-1"
                    >Email</span
                  >
                  <input
                    type="text"
                    id="card-lead-email"
                    class="w-full bg-transparent border-b border-transparent hover:border-violet-300 focus:border-violet-500 focus:outline-none font-bold text-slate-700 text-sm py-0.5 transition placeholder-slate-300"
                    placeholder="Agregar email..."
                    onchange="updateOracleContactField('email', this.value)"
                  />
                </div>
                <div
                  class="p-3 bg-slate-50 rounded-xl border border-slate-100 group hover:bg-white hover:border-violet-200 transition-colors"
                >
                  <span
                    class="block text-[10px] uppercase text-slate-400 font-bold mb-1"
                    >Tel√©fono</span
                  >
                  <input
                    type="text"
                    id="card-lead-phone"
                    class="w-full bg-transparent border-b border-transparent hover:border-violet-300 focus:border-violet-500 focus:outline-none font-bold text-slate-700 text-sm py-0.5 transition placeholder-slate-300"
                    placeholder="Agregar tel√©fono..."
                    onchange="updateOracleContactField('telefono', this.value)"
                  />
                </div>
                <div
                  class="p-3 bg-slate-50 rounded-xl border border-slate-100 group hover:bg-white hover:border-violet-200 transition-colors"
                >
                  <span
                    class="block text-[10px] uppercase text-slate-400 font-bold mb-1"
                    >Ciudad</span
                  >
                  <input
                    type="text"
                    id="card-lead-city"
                    class="w-full bg-transparent border-b border-transparent hover:border-violet-300 focus:border-violet-500 focus:outline-none font-bold text-slate-700 text-sm py-0.5 transition placeholder-slate-300"
                    placeholder="Agregar ciudad..."
                    onchange="updateOracleContactField('ciudad', this.value)"
                  />
                </div>
                <div
                  class="p-3 bg-slate-50 rounded-xl border border-slate-100 flex items-center justify-center"
                >
                  <button
                    onclick="openWhatsApp()"
                    class="text-xs font-black text-emerald-600 uppercase hover:underline flex items-center gap-1"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"
                      />
                    </svg>
                    Chat
                  </button>
                </div>
              </div>
            </div>

            <!-- Section B: Intelligence (Dynamic) -->
            <div>
              <div class="flex items-center justify-between mb-4">
                <h3
                  class="text-xs font-black text-indigo-400 uppercase tracking-widest flex items-center gap-2"
                >
                  <span
                    class="w-2 h-2 rounded-full bg-indigo-400 animate-pulse"
                  ></span>
                  Inteligencia de Negocio
                </h3>
                <button
                  onclick="triggerDeepScan()"
                  id="btn-deep-scan"
                  class="text-[10px] font-black bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-200"
                >
                  ‚ö° Deep Scan
                </button>
              </div>

              <!-- Content injected by JS -->
              <div id="card-enrichment-data">
                <!-- Placeholder / Loading State -->
                <div class="text-center py-8">
                  <div
                    class="inline-block p-4 bg-slate-50 rounded-full mb-3 text-2xl"
                  >
                    üïµÔ∏è‚Äç‚ôÇÔ∏è
                  </div>
                  <p class="text-sm font-bold text-slate-600">
                    Sin datos de inteligencia
                  </p>
                  <p class="text-xs text-slate-400 mb-4">
                    Ejecuta un Deep Scan para analizar su web.
                  </p>
                </div>
              </div>
            </div>

            <!-- Section C: Calculadora de Fuga B2C -->
            <div>
              <h3
                class="text-xs font-black text-rose-400 uppercase tracking-widest mb-4 flex items-center gap-2"
              >
                <span class="w-2 h-2 rounded-full bg-rose-400"></span>
                Calculadora de Fuga
              </h3>
              <div
                class="p-6 bg-rose-50 border border-rose-100 rounded-2xl relative overflow-hidden group"
              >
                <div
                  class="absolute -right-4 -bottom-4 opacity-[0.03] text-8xl transition-transform group-hover:scale-110"
                >
                  üí∏
                </div>
                <p class="text-sm font-bold text-slate-700 mb-1">
                  Estimaci√≥n P√©rdida Mensual
                </p>
                <p
                  class="text-[10px] text-slate-500 mb-4 max-w-[85%] leading-relaxed"
                >
                  P√©rdida estimada en horas-hombre por cotizaciones manuales y
                  porcentaje de leads ca√≠dos por respuestas lentas.
                </p>
                <div class="flex items-end gap-2">
                  <span
                    class="text-4xl font-black text-rose-600 tracking-tight"
                    id="card-loss-value"
                    >$0</span
                  >
                  <span class="text-sm font-bold text-rose-400 mb-1.5"
                    >/ mes</span
                  >
                </div>
              </div>
            </div>

            <!-- Section D: Notes -->
            <div>
              <h3
                class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"
              >
                <span class="w-2 h-2 rounded-full bg-slate-300"></span> Notas
                Privadas
              </h3>
              <textarea
                class="w-full h-32 p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-700 focus:ring-2 focus:ring-violet-500 outline-none resize-none"
                placeholder="Escribe notas sobre este lead aqu√≠..."
              ></textarea>
            </div>

            <!-- Footer Actions -->
            <div class="pt-8 border-t border-slate-100 flex gap-4">
              <button
                class="flex-1 py-3 bg-violet-600 text-white font-bold rounded-xl hover:bg-violet-700 transition shadow-lg shadow-violet-200"
              >
                ‚Üó Abrir Expediente Completo
              </button>
            </div>
          </div>
        </div>

        <!-- MATRIX SECTION REMOVED -->
      </div>
    </main>

    <script>
      // --- CONSTANTS & DATA ---
      let AUTH_TOKEN = null;
      const PROXY_URL =
        "https://zqwkwnywndkwyzzggorf.supabase.co/functions/v1/save-lead";

      // --- AUTH SYSTEM ---
      function checkPass() {
        const pass = document.getElementById("admin-pass").value;
        if (!pass) return;
        
        // --- VALIDACI√ìN DE ENTRADA ---
        if (pass !== 'solar2026') {
          const err = document.getElementById("pass-error");
          if (err) {
            err.classList.remove("hidden");
            setTimeout(() => err.classList.add("hidden"), 3000);
          }
          return;
        }

        AUTH_TOKEN = pass;

        // Entrance animation
        document.getElementById("login-overlay").style.transition = "opacity 0.5s ease";
        document.getElementById("login-overlay").style.opacity = "0";
        
        // Show the content
        document.getElementById("oracle-section").classList.remove("hidden");

        setTimeout(
          () => document.getElementById("login-overlay").remove(),
          500,
        );
        loadOracleData();
      }

      // Legacy functions removed

      // --- NAVIGATION & MATRIX ---
      function showSection(id) {
        // Scroll reset
        document.getElementById("main-scroll").scrollTop = 0;

        // Header Update
        const titles = {
          oracle: "üëÅÔ∏è Motor Inteligencia B2B",
        };
        document.getElementById("header-title").innerText = titles[id] || id;

        // Load Oracle data on first visit
        if (id === "oracle" && !window._oracleLoaded) {
          window._oracleLoaded = true;
          initOracleParticles();
          loadOracleData();
        }
      }

      // Task logic removed to optimize the panel      // --- MOBILE MENU ---
      let mobileMenuOpen = false;
      function toggleMobileMenu(force) {
        const sb = document.getElementById("sidebar");
        const ov = document.getElementById("overlay");
        mobileMenuOpen = typeof force === "boolean" ? force : !mobileMenuOpen;

        if (mobileMenuOpen) {
          sb.classList.remove("-translate-x-full");
          ov.classList.remove("hidden");
        } else {
          sb.classList.add("-translate-x-full");
          ov.classList.add("hidden");
        }
      }

      // ============================================================
      // MOTOR ORACLE IA - JavaScript
      // ============================================================

      const ORACLE_BRAIN_URL =
        "https://zqwkwnywndkwyzzggorf.supabase.co/functions/v1/oracle-brain";
      const PROXY_URL_ORACLE =
        "https://zqwkwnywndkwyzzggorf.supabase.co/functions/v1/save-lead";
      let _oracleLeadsData = [];

      async function loadOracleData() {
        const pass = AUTH_TOKEN || "";
        if (!pass) {
          console.warn("Oracle: no password ‚Äî inicia sesi√≥n primero");
          return;
        }

        try {
          // Parallel fetch for speed
          const [leadsResp, distResp, logResp] = await Promise.all([
            fetch(PROXY_URL_ORACLE, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "get-oracle-leads",
                payload: { password: pass },
              }),
            }),
            fetch(PROXY_URL_ORACLE, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "get-distributors",
                payload: { password: pass },
              }),
            }),
            fetch(PROXY_URL_ORACLE, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "get-oracle-log",
                payload: { password: pass },
              }),
            }),
          ]);

          const leadsResult = await leadsResp.json();
          const distResult = await distResp.json();
          const logResult = await logResp.json();

          let distributors = [];
          if (distResult.success) {
            distributors = distResult.data || [];
            window._oracleDistributorsData = distributors; // Expose globally
            renderDistributors(distributors);
            const changes = distributors.filter(
              (d) => d.status_scan === "Cambio Detectado",
            ).length;
            document.getElementById("oracle-kpi-changes").textContent = changes;
          }

          let _oracleTotalCount = 0;

          if (leadsResult.success) {
            _oracleLeadsData = leadsResult.data || [];
            _oracleTotalCount = leadsResult.count || _oracleLeadsData.length;

            // Asignar numeraci√≥n cronol√≥gica: el lead m√°s antiguo es el #1
            // Como los datos vienen ordenados por detectado_en DESC (los nuevos primero en index 0)
            _oracleLeadsData.forEach(
              (l, i) => (l._globalIndex = _oracleTotalCount - i),
            );

            renderOracleLeads(_oracleLeadsData);
            document.getElementById("sidebar-oracle-count").textContent =
              _oracleLeadsData.filter((l) => l.estado === "Nuevo").length;
          }

          // Update KPIs and Intelligence widgets with ALL data
          updateOracleKPIs(_oracleLeadsData, distributors, _oracleTotalCount);

          if (logResult.success) renderScanLog(logResult.data || []);
        } catch (e) {
          console.error("Oracle Load Error:", e);
        }
      }

      function updateOracleKPIs(leads, distributors, totalCount) {
        // En vez de usar split de UTC, usamos la fecha local
        const today = new Date().toLocaleDateString("en-CA");
        const todayLeads = leads.filter((l) => {
          return new Date(l.detectado_en).toLocaleDateString("en-CA") === today;
        });

        const avgScore =
          leads.length > 0
            ? Math.round(
                leads.reduce((s, l) => s + (l.score || 0), 0) / leads.length,
              )
            : 0;

        // Animated counter
        function animateCount(el, target, suffix = "") {
          if (!el) return;
          const start = parseInt(el.textContent) || 0;
          const duration = 800;
          const startTime = performance.now();
          function step(now) {
            const progress = Math.min((now - startTime) / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            el.textContent =
              Math.round(start + (target - start) * eased) + suffix;
            if (progress < 1) requestAnimationFrame(step);
          }
          requestAnimationFrame(step);
        }

        animateCount(
          document.getElementById("oracle-kpi-total"),
          totalCount || leads.length,
        );
        animateCount(
          document.getElementById("oracle-kpi-today"),
          todayLeads.length,
        );
        animateCount(
          document.getElementById("oracle-kpi-score"),
          avgScore,
          "/100",
        );

        // Trend badges
        const totalTrend = document.getElementById("oracle-kpi-total-trend");
        if (totalTrend)
          totalTrend.textContent = leads.length > 0 ? `+${leads.length}` : "‚Äî";
        const scoreTrend = document.getElementById("oracle-kpi-score-trend");
        if (scoreTrend)
          scoreTrend.textContent =
            avgScore >= 60
              ? "üî• Alto"
              : avgScore >= 40
                ? "üìà Medio"
                : "üìâ Bajo";

        // Update hero last scan
        if (leads.length > 0) {
          const latest = leads.reduce((a, b) =>
            new Date(a.detectado_en) > new Date(b.detectado_en) ? a : b,
          );
          const heroScan = document.getElementById("oracle-hero-last-scan");
          if (heroScan) heroScan.textContent = timeAgo(latest.detectado_en);
        }

        // Draw sparklines (simulate 7-day trend from data)
        const days = 7;
        const dayBuckets = Array.from({ length: days }, (_, i) => {
          const d = new Date();
          d.setDate(d.getDate() - (days - 1 - i));
          return d.toISOString().split("T")[0];
        });
        const dailyCounts = dayBuckets.map(
          (day) => leads.filter((l) => l.detectado_en?.startsWith(day)).length,
        );
        const dailyScores = dayBuckets.map((day) => {
          const dl = leads.filter((l) => l.detectado_en?.startsWith(day));
          return dl.length > 0
            ? Math.round(dl.reduce((s, l) => s + (l.score || 0), 0) / dl.length)
            : 0;
        });

        drawSparkline("spark-total", dailyCounts, "#7c3aed");
        drawSparkline("spark-today", dailyCounts, "#10b981");
        drawSparkline("spark-score", dailyScores, "#f59e0b");
        drawSparkline(
          "spark-changes",
          dayBuckets.map(() => Math.floor(Math.random() * 2)),
          "#ef4444",
        );

        // Render new Phase 1 components
        renderOracleLeaderboard(leads);
        renderOracleAlerts(leads, distributors || []);
        renderOracleThermometer(leads, distributors || []);

        // Phase 2 Calls
        initOracleFeed(leads, distributors || []);
        renderOraclePipeline(leads);
        renderOracleCharts(leads);
        renderOracleNetwork(leads, distributors || []);
      }

      // ‚îÄ‚îÄ‚îÄ #1 PARTICLES ‚Äî Hero Banner Animation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function initOracleParticles() {
        const canvas = document.getElementById("oracle-particles-canvas");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        let particles = [];
        let animId;

        function resize() {
          canvas.width = canvas.offsetWidth;
          canvas.height = canvas.offsetHeight;
        }
        resize();
        window.addEventListener("resize", resize);

        for (let i = 0; i < 55; i++) {
          particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: Math.random() * 1.8 + 0.4,
            vx: (Math.random() - 0.5) * 0.4,
            vy: (Math.random() - 0.5) * 0.4,
            alpha: Math.random() * 0.6 + 0.2,
            color: Math.random() > 0.5 ? "#a78bfa" : "#34d399",
          });
        }

        function draw() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particles.forEach((p) => {
            p.x += p.vx;
            p.y += p.vy;
            if (p.x < 0) p.x = canvas.width;
            if (p.x > canvas.width) p.x = 0;
            if (p.y < 0) p.y = canvas.height;
            if (p.y > canvas.height) p.y = 0;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.alpha;
            ctx.fill();
          });
          // Draw connecting lines between nearby particles
          ctx.globalAlpha = 0.08;
          ctx.strokeStyle = "#a78bfa";
          ctx.lineWidth = 0.5;
          for (let i = 0; i < particles.length; i++) {
            for (let j = i + 1; j < particles.length; j++) {
              const dx = particles[i].x - particles[j].x;
              const dy = particles[i].y - particles[j].y;
              const dist = Math.sqrt(dx * dx + dy * dy);
              if (dist < 80) {
                ctx.beginPath();
                ctx.moveTo(particles[i].x, particles[i].y);
                ctx.lineTo(particles[j].x, particles[j].y);
                ctx.stroke();
              }
            }
          }
          ctx.globalAlpha = 1;
          animId = requestAnimationFrame(draw);
        }
        draw();
      }

      // ‚îÄ‚îÄ‚îÄ #2 SPARKLINES ‚Äî Mini charts for KPI cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function drawSparkline(canvasId, data, color) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        canvas.width = canvas.offsetWidth || 160;
        const ctx = canvas.getContext("2d");
        const w = canvas.width,
          h = canvas.height;
        const max = Math.max(...data, 1);
        const min = Math.min(...data, 0);
        const range = max - min || 1;
        const pts = data.map((v, i) => ({
          x: (i / (data.length - 1)) * w,
          y: h - ((v - min) / range) * (h - 4) - 2,
        }));

        ctx.clearRect(0, 0, w, h);

        // Gradient fill
        const grad = ctx.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, color + "44");
        grad.addColorStop(1, color + "00");
        ctx.beginPath();
        ctx.moveTo(pts[0].x, h);
        pts.forEach((p) => ctx.lineTo(p.x, p.y));
        ctx.lineTo(pts[pts.length - 1].x, h);
        ctx.closePath();
        ctx.fillStyle = grad;
        ctx.fill();

        // Line
        ctx.beginPath();
        pts.forEach((p, i) =>
          i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y),
        );
        ctx.strokeStyle = color;
        ctx.lineWidth = 1.5;
        ctx.lineJoin = "round";
        ctx.stroke();

        // Last dot
        const last = pts[pts.length - 1];
        ctx.beginPath();
        ctx.arc(last.x, last.y, 2.5, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
      }

      // ‚îÄ‚îÄ‚îÄ #4 LEADERBOARD ‚Äî Top 10 leads by score ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderOracleLeaderboard(leads) {
        const container = document.getElementById("oracle-leaderboard");
        if (!container) return;
        if (!leads.length) {
          container.innerHTML =
            '<p class="text-slate-300 text-sm text-center py-4">Sin leads a√∫n.</p>';
          return;
        }

        const top10 = [...leads]
          .sort((a, b) => (b.score || 0) - (a.score || 0))
          .slice(0, 10);
        const medals = ["ü•á", "ü•à", "ü•â"];

        container.innerHTML = top10
          .map((lead, i) => {
            const score = parseInt(lead.score) || 0;
            const pct = Math.min(100, Math.max(0, score));
            const isHot = score >= 75;
            const medal =
              medals[i] ||
              `<span class="text-xs font-black text-slate-400">${i + 1}</span>`;
            const barColor =
              score >= 70 ? "#10b981" : score >= 40 ? "#f59e0b" : "#94a3b8";
            const name = (lead.nombre_empresa || "Empresa").substring(0, 22);

            return `
                <div onclick="openLeadCard('${lead.id}')" class="flex items-center gap-2 group cursor-pointer hover:bg-slate-50 p-1.5 rounded-lg transition-colors">
                    <span class="text-base w-6 flex-shrink-0 text-center">${medal}</span>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-0.5">
                            <span class="text-xs font-bold text-slate-700 truncate group-hover:text-violet-600">${name}</span>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                ${isHot ? '<span class="text-[9px]">üî•</span>' : ""}
                                <span class="text-[10px] font-black" style="color:${barColor}">${score}</span>
                            </div>
                        </div>
                        <div class="w-full h-1.5 rounded-full bg-slate-100 overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-700" style="width:${pct}%;background:${barColor};"></div>
                        </div>
                    </div>
                </div>`;
          })
          .join("");
      }


      // ‚îÄ‚îÄ‚îÄ #9 ALERTS ‚Äî Smart alert cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderOracleAlerts(leads, distributors) {
        const container = document.getElementById("oracle-alerts-list");
        const badge = document.getElementById("oracle-alerts-badge");
        if (!container) return;

        const alerts = [];
        const today = new Date().toISOString().split("T")[0];
        const todayLeads = leads.filter((l) =>
          l.detectado_en?.startsWith(today),
        );
        const hotLeads = leads.filter((l) => (l.score || 0) >= 75);
        const changedDists = distributors.filter(
          (d) => d.status_scan === "Cambio Detectado",
        );
        const uncontacted = leads.filter((l) => l.estado === "Nuevo");
        const avgScore =
          leads.length > 0
            ? Math.round(
                leads.reduce((s, l) => s + (l.score || 0), 0) / leads.length,
              )
            : 0;

        // Generate alerts based on data
        if (changedDists.length > 0) {
          alerts.push({
            level: "red",
            icon: "üî¥",
            title: `${changedDists.map((d) => d.nombre).join(", ")} cambi√≥ tarifas`,
            desc: "Oportunidad de contacto urgente con clientes afectados",
          });
        }
        if (hotLeads.length > 0) {
          alerts.push({
            level: "amber",
            icon: "üî•",
            title: `${hotLeads.length} lead${hotLeads.length > 1 ? "s" : ""} con score ‚â• 75`,
            desc: `${hotLeads[0]?.nombre_empresa || "Top lead"} es el m√°s prometedor`,
          });
        }
        if (todayLeads.length > 0) {
          alerts.push({
            level: "violet",
            icon: "üì°",
            title: `${todayLeads.length} nuevos leads detectados hoy`,
            desc: "El agente Oracle complet√≥ el escaneo diario",
          });
        }
        if (uncontacted.length > 5) {
          alerts.push({
            level: "blue",
            icon: "üìã",
            title: `${uncontacted.length} leads sin contactar`,
            desc: "Revisa el pipeline ‚Äî hay oportunidades pendientes",
          });
        }
        if (avgScore >= 60) {
          alerts.push({
            level: "green",
            icon: "üìà",
            title: `Score promedio alto: ${avgScore}/100`,
            desc: "La calidad del mercado detectado es excelente esta semana",
          });
        }
        if (alerts.length === 0) {
          alerts.push({
            level: "slate",
            icon: "‚úÖ",
            title: "Todo en orden",
            desc: "Sin alertas activas. El sistema monitorea continuamente.",
          });
        }

        const levelStyles = {
          red: {
            bg: "bg-red-50",
            border: "border-red-200",
            text: "text-red-700",
          },
          amber: {
            bg: "bg-amber-50",
            border: "border-amber-200",
            text: "text-amber-700",
          },
          violet: {
            bg: "bg-violet-50",
            border: "border-violet-200",
            text: "text-violet-700",
          },
          blue: {
            bg: "bg-blue-50",
            border: "border-blue-200",
            text: "text-blue-700",
          },
          green: {
            bg: "bg-emerald-50",
            border: "border-emerald-200",
            text: "text-emerald-700",
          },
          slate: {
            bg: "bg-slate-50",
            border: "border-slate-200",
            text: "text-slate-500",
          },
        };

        if (badge)
          badge.textContent =
            alerts.filter((a) => a.level !== "slate").length + " activas";

        container.innerHTML = alerts
          .map((a) => {
            const s = levelStyles[a.level] || levelStyles.slate;
            return `
                <div class="flex gap-3 p-3 rounded-xl border ${s.bg} ${s.border}">
                    <span class="text-base flex-shrink-0 mt-0.5">${a.icon}</span>
                    <div class="min-w-0">
                        <p class="text-xs font-black ${s.text} leading-tight">${a.title}</p>
                        <p class="text-[10px] text-slate-400 mt-0.5 leading-tight">${a.desc}</p>
                    </div>
                </div>`;
          })
          .join("");
      }

      // ‚îÄ‚îÄ‚îÄ #12 THERMOMETER ‚Äî Market temperature ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderOracleThermometer(leads, distributors) {
        const bar = document.getElementById("oracle-thermo-bar");
        const needle = document.getElementById("oracle-thermo-needle");
        const emoji = document.getElementById("oracle-thermo-emoji");
        const label = document.getElementById("oracle-thermo-label");
        const desc = document.getElementById("oracle-thermo-desc");
        if (!bar) return;

        // Calculate temperature score (0-100)
        const today = new Date().toISOString().split("T")[0];
        const todayCount = leads.filter((l) =>
          l.detectado_en?.startsWith(today),
        ).length;
        const avgScore =
          leads.length > 0
            ? leads.reduce((s, l) => s + (l.score || 0), 0) / leads.length
            : 0;
        const changesCount = distributors.filter(
          (d) => d.status_scan === "Cambio Detectado",
        ).length;
        const hotLeadsCount = leads.filter((l) => (l.score || 0) >= 70).length;

        // Weighted formula
        let temp = 0;
        temp += Math.min(todayCount * 3, 30); // hasta 30pts por leads hoy
        temp += Math.min(avgScore * 0.3, 30); // hasta 30pts por score promedio
        temp += Math.min(changesCount * 10, 20); // hasta 20pts por cambios tarifas
        temp += Math.min(hotLeadsCount * 2, 20); // hasta 20pts por leads calientes
        temp = Math.min(Math.round(temp), 100);

        // Determine level
        let lvl;
        if (temp < 25)
          lvl = {
            emoji: "‚ùÑÔ∏è",
            label: "Mercado Fr√≠o",
            desc: "Poca actividad detectada. Considera ampliar b√∫squeda.",
            color: "#60a5fa",
          };
        else if (temp < 50)
          lvl = {
            emoji: "üå§Ô∏è",
            label: "Mercado Tibio",
            desc: "Actividad moderada. Hay oportunidades por explorar.",
            color: "#34d399",
          };
        else if (temp < 75)
          lvl = {
            emoji: "‚òÄÔ∏è",
            label: "Mercado Caliente",
            desc: "Alta actividad. Buen momento para contactar leads.",
            color: "#fbbf24",
          };
        else
          lvl = {
            emoji: "üî•",
            label: "¬°Mercado en llamas!",
            desc: "M√°xima actividad. Prioriza los leads hot ahora.",
            color: "#f87171",
          };

        // Animate after a short delay
        setTimeout(() => {
          bar.style.width = temp + "%";
          needle.style.left = Math.max(0, temp - 1) + "%";
          emoji.textContent = lvl.emoji;
          label.textContent = lvl.label;
          desc.textContent = lvl.desc;
        }, 300);
      }

      // ‚îÄ‚îÄ‚îÄ #10 DISTRIBUTORS (Grid & Modal) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      // Metadata Est√°tica "Investigada" por Oracle IA
      const DISTRIBUTOR_METADATA = {
        CGE: {
          clientes: "3.2 Millones",
          zona: "Arica a la Araucan√≠a",
          perfil: "Distribuci√≥n Masiva / Rural",
          red: "A√©rea (Predominante)",
          insight:
            "CGE es la mayor distribuidora por extensi√≥n territorial en Chile. Su red rural presenta desaf√≠os de estabilidad, pero ofrece tarifas BT1 competitivas en zonas medias.",
        },
        Enel: {
          clientes: "2.1 Millones",
          zona: "Regi√≥n Metropolitana (Exclusiva)",
          perfil: "Urbana / Alta Densidad",
          red: "Subterr√°nea / A√©rea H√≠brida",
          insight:
            "Enel Distribuci√≥n concentra la mayor densidad de carga del pa√≠s. Pionera en smart metering, sus tarifas BT1 suelen ser referentes para el mercado regulado central.",
        },
        Chilquinta: {
          clientes: "600.000+",
          zona: "Regi√≥n de Valpara√≠so",
          perfil: "Regional / Costera",
          red: "Alta Resiliencia",
          insight:
            "Operada por State Grid (China). Destaca por su alta calidad de servicio en la V Regi√≥n y r√°pida respuesta ante fallas costeras.",
        },
        Saesa: {
          clientes: "950.000 (Grupo)",
          zona: "Biob√≠o a Los Lagos",
          perfil: "Sur / Clima Adverso",
          red: "Rural Exigente",
          insight:
            "Grupo Saesa lidera la distribuci√≥n en el sur de Chile. Expertos en mantenimiento bajo condiciones clim√°ticas extremas. Alta penetraci√≥n de generaci√≥n distribuida rural.",
        },
        Frontel: {
          clientes: "400.000+",
          zona: "Biob√≠o y Araucan√≠a Rural",
          perfil: "Rural Dispersa",
          red: "Baja y Media Tensi√≥n Extensa",
          insight:
            "Filial del Grupo Saesa enfocada en zonas rurales. Tarifas BT1 variables debido a los costos de transmisi√≥n zonal.",
        },
        Transelec: {
          // Aunque es transmisi√≥n, a veces aparece en facturas grandes
          clientes: "N/A (Transmisi√≥n)",
          zona: "Nacional",
          perfil: "Alta Tensi√≥n",
          red: "500kV / 220kV",
          insight:
            "Principal empresa de transmisi√≥n de Chile. Conecta la generaci√≥n con los centros de consumo masivo.",
        },
      };

      function renderDistributors(distributors) {
        const container = document.getElementById("oracle-distributors-list");
        if (!distributors.length) {
          container.innerHTML =
            '<p class="text-slate-400 text-sm text-center py-4">Sin datos. Ejecuta el primer escaneo.</p>';
          return;
        }

        container.className =
          "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"; // Grid Layout

        container.innerHTML = distributors
          .map((d) => {
            const isOK = d.status_scan === "OK";
            const isPending = d.status_scan === "Pendiente";
            const statusColor = isOK
              ? "text-emerald-500"
              : isPending
                ? "text-slate-300"
                : "text-amber-500";
            const dotColor = isOK
              ? "bg-emerald-400"
              : isPending
                ? "bg-slate-200"
                : "bg-amber-400";
            const tariff = d.tarifa_bt1_actual
              ? `$${d.tarifa_bt1_actual}`
              : "‚Äî";
            const lastScan = d.ultimo_scan ? timeAgo(d.ultimo_scan) : "hace 3h"; // Mock default if missing
            const boletas = d.boletas_count || 0;

            // Match Metadata
            const metaKey = Object.keys(DISTRIBUTOR_METADATA).find((k) =>
              (d.nombre || "").includes(k),
            );
            const meta = metaKey ? DISTRIBUTOR_METADATA[metaKey] : null;

            return `
                <div onclick="openDistributorModal('${d.nombre}', '${d.status_scan}', '${d.tarifa_bt1_actual}', ${boletas})" 
                    class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition cursor-pointer group relative overflow-hidden">
                    
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-2.5 h-2.5 rounded-full ${dotColor} ${!isPending ? "shadow-[0_0_8px_rgba(16,185,129,0.4)]" : ""}"></div>
                            <div>
                                <h4 class="font-black text-slate-700 text-sm leading-tight group-hover:text-violet-600 transition">${d.nombre}</h4>
                                <p class="text-[10px] text-slate-400 font-medium">${lastScan} ¬∑ BT1: ${tariff}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            ${
                              isOK
                                ? `<div class="flex items-center gap-1 text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg">
                                     <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                     <span class="text-[10px] font-black">OK</span>
                                   </div>`
                                : `<div class="flex items-center gap-1 text-slate-300">
                                     <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                     <span class="text-[10px] font-bold">Pendiente</span>
                                   </div>`
                            }
                        </div>
                    </div>
                </div>`;
          })
          .join("");
      }

      function openDistributorModal(name, status, tariff, boletas) {
        // Find Metadata
        const metaKey = Object.keys(DISTRIBUTOR_METADATA).find((k) =>
          name.includes(k),
        );
        const meta = metaKey
          ? DISTRIBUTOR_METADATA[metaKey]
          : {
              clientes: "Desconocido",
              zona: "Nacional",
              perfil: "Est√°ndar",
              red: "General",
              insight: "Empresa distribuidora en monitoreo.",
            };

        const modalHtml = `
            <div id="oracle-distributor-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm animate-fade-in p-4">
                <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl border border-white/50 overflow-hidden relative">
                    <!-- Close Button -->
                    <button onclick="document.getElementById('oracle-distributor-modal').remove()" class="absolute top-4 right-4 z-10 p-2 bg-slate-100/80 hover:bg-slate-200 rounded-full text-slate-500 transition">
                       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>

                    <!-- Header with Branding -->
                    <div class="bg-slate-50 p-8 pb-12 relative overflow-hidden">
                        <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 20px 20px;"></div>
                        <div class="relative z-10 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-white rounded-2xl shadow-lg flex items-center justify-center text-3xl">‚ö°</div>
                                <div>
                                    <h2 class="text-2xl font-black text-slate-800">${name}</h2>
                                    <p class="text-sm font-medium text-slate-500 flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full ${status === "OK" ? "bg-emerald-400" : "bg-amber-400"}"></span>
                                        Estado: ${status}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">TARIFA BT1 VIGENTE</p>
                                <p class="text-3xl font-black text-indigo-600">${tariff ? "$" + tariff : "‚Äî"}<span class="text-sm text-slate-400 font-medium"> /kWh</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Content Body -->
                    <div class="p-8 -mt-6 bg-white rounded-t-3xl relative z-20">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Cobertura</p>
                                <p class="font-bold text-slate-700">${meta.zona}</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Clientes Aprox</p>
                                <p class="font-bold text-slate-700">${meta.clientes}</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Red Predominante</p>
                                <p class="font-bold text-slate-700">${meta.red}</p>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start">
                             <div class="w-10 h-10 rounded-xl bg-violet-100 flex items-center justify-center text-violet-600 flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                             </div>
                             <div>
                                <h4 class="font-black text-slate-800 mb-2">An√°lisis Motor Oracle IA</h4>
                                <p class="text-sm text-slate-600 leading-relaxed">${meta.insight}</p>
                                <div class="mt-4 flex gap-2">
                                    <span class="px-3 py-1 bg-slate-100 text-slate-500 rounded-lg text-xs font-bold">Perfil: ${meta.perfil}</span>
                                    ${boletas > 0 ? `<span class="px-3 py-1 bg-emerald-100 text-emerald-600 rounded-lg text-xs font-bold">‚úÖ ${boletas} Documentos Auditados</span>` : ""}
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        document.body.insertAdjacentHTML("beforeend", modalHtml);
      }

      function renderOracleLeads(leads) {
        const tbody = document.getElementById("oracle-leads-tbody");
        if (!leads.length) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center py-8 text-slate-300 text-sm">Sin leads detectados a√∫n. Ejecuta el primer escaneo.</td></tr>';
          return;
        }

        const estadoColors = {
          Nuevo: "bg-violet-100 text-violet-700",
          Revisado: "bg-blue-100 text-blue-700",
          Contactado: "bg-emerald-100 text-emerald-700",
          Descartado: "bg-slate-100 text-slate-500",
          Cliente: "bg-amber-100 text-amber-700",
        };

        // Fecha local de hoy (YYYY-MM-DD)
        const todayKey = new Date().toLocaleDateString("en-CA"); // formato ISO local

        // Agrupar leads por d√≠a (clave: YYYY-MM-DD en hora local)
        const groups = {};
        leads.forEach((lead) => {
          const d = new Date(lead.detectado_en);
          const key = d.toLocaleDateString("en-CA");
          if (!groups[key]) groups[key] = [];
          groups[key].push(lead);
        });

        // Ordenar d√≠as: m√°s reciente primero
        const sortedDays = Object.keys(groups).sort((a, b) =>
          b.localeCompare(a),
        );

        // Formatear nombre del d√≠a
        function formatDayLabel(key) {
          const d = new Date(key + "T12:00:00"); // mediod√≠a para evitar offset
          return d.toLocaleDateString("es-CL", {
            weekday: "long",
            day: "numeric",
            month: "long",
            year: "numeric",
          });
        }

        // Renderizar una fila de lead
        function leadRow(lead, groupId, isHidden) {
          const globalIndex = lead._globalIndex || "";
          const scoreColor =
            lead.score >= 70
              ? "text-emerald-600"
              : lead.score >= 40
                ? "text-amber-500"
                : "text-slate-400";
          const estadoBadge =
            estadoColors[lead.estado] || "bg-slate-100 text-slate-500";
          const webLink = `<button onclick="openLeadCard('${lead.id}')" class="text-left font-bold text-slate-700 hover:text-violet-600 transition flex items-center gap-2 group-hover:underline">
                    <span class="text-[10px] bg-slate-100 text-slate-400 px-1.5 py-0.5 rounded mr-1 font-mono tracking-tighter">#${globalIndex}</span>
                    ${lead.nombre_empresa || "Empresa Sin Nombre"}
                    <svg class="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                </button>`;
          const hora = new Date(lead.detectado_en).toLocaleTimeString("es-CL", {
            hour: "2-digit",
            minute: "2-digit",
          });
          return `
                <tr onclick="openLeadCard('${lead.id}')" class="border-b border-slate-50 hover:bg-violet-50/30 transition lead-row ${groupId} ${isHidden ? "hidden" : ""} cursor-pointer group">
                    <td class="py-3 px-2">${webLink}</td>
                    <td class="py-3 px-2 font-black ${scoreColor}">${lead.score || 0}</td>
                    <td class="py-3 px-2 text-slate-500 text-xs">${lead.ciudad || "‚Äî"}</td>
                    <td class="py-3 px-2 text-slate-400 text-xs">${hora}</td>
                    <td class="py-3 px-2">
                        <span class="px-2 py-1 rounded-lg text-[10px] font-black ${estadoBadge}">${lead.estado}</span>
                    </td>
                    <td class="py-3 px-2">
                        <select onchange="updateOracleLeadStatus('${lead.id}', this.value)" class="text-[10px] border border-slate-200 rounded-lg px-2 py-1 font-semibold text-slate-600">
                            <option value="">Cambiar...</option>
                            <option value="Revisado">Revisado</option>
                            <option value="Contactado">Contactado</option>
                            <option value="Descartado">Descartar</option>
                            <option value="Cliente">¬°Cliente!</option>
                        </select>
                    </td>
                </tr>`;
        }

        let html = "";

        sortedDays.forEach((dayKey, idx) => {
          const dayLeads = groups[dayKey];
          const isToday = dayKey === todayKey;
          const groupId = `oracle-group-${dayKey}`;

          // Abrir por defecto hoy y el primero
          const openByDefault = isToday || idx === 0;

          // Formateo del t√≠tulo del d√≠a
          const dayLabelText = isToday
            ? `HOY ‚Äî ${formatDayLabel(dayKey).toUpperCase()}`
            : formatDayLabel(dayKey).toUpperCase();

          html += `
                <tr class="cursor-pointer select-none group bg-slate-50/20" onclick="toggleOracleGroupRows('${groupId}')">
                    <td colspan="6" class="py-3 px-2">
                        <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 hover:bg-slate-100 transition border border-slate-100">
                            <span id="${groupId}-arrow" class="text-slate-400 font-black text-[10px] transition-transform duration-200 ${openByDefault ? "rotate-90" : ""}">&#9654;</span>
                            <span class="font-bold text-slate-500 text-[10px] uppercase tracking-widest flex items-center gap-2">
                                ${isToday ? '<span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse shadow-[0_0_8px_rgba(52,211,153,0.5)]"></span>' : ""}
                                ${dayLabelText}
                            </span>
                            <span class="ml-auto px-2.5 py-1 bg-violet-100 text-violet-700 rounded-lg text-[10px] font-black shadow-sm">${dayLeads.length} leads</span>
                        </div>
                    </td>
                </tr>
                `;

          html += dayLeads
            .map((lead) => leadRow(lead, groupId, !openByDefault))
            .join("");
        });

        tbody.innerHTML = html;
      }

      function toggleOracleGroupRows(groupId) {
        const rows = document.querySelectorAll("." + groupId);
        const arrow = document.getElementById(groupId + "-arrow");
        if (rows.length === 0) return;

        const isHidden = rows[0].classList.contains("hidden");

        rows.forEach((r) => {
          r.classList.toggle("hidden", !isHidden);
        });

        if (arrow) {
          arrow.style.transform = isHidden ? "rotate(90deg)" : "rotate(0deg)";
          if (isHidden) {
            arrow.classList.add("rotate-90");
          } else {
            arrow.classList.remove("rotate-90");
          }
        }
      }

      function filterOracleLeads() {
        const filter = document.getElementById("oracle-leads-filter").value;
        const filtered =
          filter === "all"
            ? _oracleLeadsData
            : _oracleLeadsData.filter((l) => l.estado === filter);
        renderOracleLeads(filtered);
      }

      function renderScanLog(logs) {
        const tbody = document.getElementById("oracle-log-tbody");
        if (!logs.length) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center py-6 text-slate-300 text-sm">Sin escaneos registrados a√∫n.</td></tr>';
          return;
        }

        const statusColors = {
          COMPLETED: "text-emerald-600",
          RUNNING: "text-blue-500 animate-pulse",
          ERROR: "text-red-500",
        };
        
        // --- FILTRO DE LIMPIEZA EXTREMA ---
        // Solo mostramos COMPLETED y RUNNING. Los ERROR se ocultan siempre.
        const filteredLogs = (logs || []).filter(l => l && (l.status === 'COMPLETED' || l.status === 'RUNNING'));
        
        if (!filteredLogs.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-slate-300 text-xs italic">Limpieza activa: Solo se muestran escaneos exitosos.</td></tr>';
            return;
        }

        tbody.innerHTML = filteredLogs
          .slice(0, 15)
          .map((log) => {
            const dur = log.duration_ms
              ? `${(log.duration_ms / 1000).toFixed(1)}s`
              : "‚Äî";
            const color = statusColors[log.status] || "text-slate-500";
            return `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                    <td class="py-3 px-3 text-xs text-slate-500">${new Date(log.started_at).toLocaleString("es-CL")}</td>
                    <td class="py-3 px-3"><span class="px-2 py-1 bg-slate-100 rounded-lg text-[10px] font-black text-slate-600">${log.scan_type}</span></td>
                    <td class="py-3 px-3 font-black text-xs ${color}">${log.status}</td>
                    <td class="py-3 px-3 text-center font-bold text-violet-600">${log.leads_new ?? "‚Äî"}</td>
                    <td class="py-3 px-3 text-center font-bold text-amber-500">${log.distributor_changes ?? "‚Äî"}</td>
                    <td class="py-3 px-3 text-xs text-slate-400">${dur}</td>
                </tr>`;
          })
          .join("");
      }

      // ‚îÄ‚îÄ‚îÄ #5 LIVE FEED ‚Äî Marquee Ticker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function initOracleFeed(leads, distributors) {
        const track = document.getElementById("oracle-feed-track");
        if (!track) return;

        const events = [];

        // Add latest leads
        leads.slice(0, 5).forEach((l) => {
          const time = new Date(l.detectado_en).toLocaleTimeString("es-CL", {
            hour: "2-digit",
            minute: "2-digit",
          });
          events.push(
            `üîç ${time} ‚Äî Nuevo lead: <span class="font-bold text-white">${l.nombre_empresa}</span> (Score: ${l.score})`,
          );
        });

        // Add distributor changes
        distributors
          .filter((d) => d.status_scan === "Cambio Detectado")
          .forEach((d) => {
            events.push(
              `‚ö° ALERTA ‚Äî <span class="font-bold text-amber-400">${d.nombre}</span> cambi√≥ sus tarifas hoy`,
            );
          });

        // Add system events
        events.push(
          `‚úÖ Sistema Oracle activo: monitoreando ${leads.length} leads en tiempo real`,
        );
        events.push(`üß† Gemini AI analizando mercado...`);

        track.innerHTML = events
          .map((e) => `<span class="inline-block mx-8">${e}</span>`)
          .join("");
      }

      // ‚îÄ‚îÄ‚îÄ #11 PIPELINE CRM ‚Äî Kanban Board ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderOraclePipeline(leads) {
        const cols = {
          Nuevo: "pipeline-col-Nuevo",
          Revisado: "pipeline-col-Revisado",
          Contactado: "pipeline-col-Contactado",
        };
        const flow = ["Nuevo", "Revisado", "Contactado", "Cliente"];

        // Clear cols
        Object.values(cols).forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = "";
        });

        // Populate
        leads.forEach((lead) => {
          const status = lead.estado || "Nuevo";
          const colId = cols[status];
          if (!colId) return;

          const card = document.createElement("div");
          card.className =
            "bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition cursor-pointer group relative overflow-hidden";
          card.onclick = (e) => {
            // Prevent modal if clicking buttons
            if (e.target.closest("button")) return;
            showOracleModal(lead.id);
          };

          const scoreColor =
            lead.score >= 70 ? "text-emerald-500" : "text-amber-500";

          // Navigation buttons
          const currentIdx = flow.indexOf(status);
          const prevStatus = currentIdx > 0 ? flow[currentIdx - 1] : null;
          const nextStatus =
            currentIdx < flow.length - 1 ? flow[currentIdx + 1] : null;

          const btnPrev = prevStatus
            ? `<button onclick="updateOracleLeadStatus('${lead.id}', '${prevStatus}')" title="Mover a ${prevStatus}" class="p-1.5 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>`
            : "<div></div>";
          const btnNext = nextStatus
            ? `<button onclick="updateOracleLeadStatus('${lead.id}', '${nextStatus}')" title="Mover a ${nextStatus}" class="p-1.5 rounded-lg hover:bg-emerald-50 text-emerald-500 hover:text-emerald-700 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>`
            : "<div></div>";

          card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="text-sm font-bold text-slate-700 leading-tight">${lead.nombre_empresa}</h5>
                        <span class="text-[10px] font-black ${scoreColor} bg-slate-50 px-1.5 py-0.5 rounded">${lead.score}</span>
                    </div>
                    <p class="text-[10px] text-slate-400 mb-3">${lead.ciudad || "Ubicaci√≥n desconocida"}</p>
                    <div class="flex justify-between items-center mt-2 border-t border-slate-50 pt-2">
                        ${btnPrev}
                        <span class="text-[9px] font-bold text-slate-300 uppercase tracking-widest">Mover</span>
                        ${btnNext}
                    </div>
                `;
          document.getElementById(colId)?.appendChild(card);
        });

        // Update counts
        Object.keys(cols).forEach((status) => {
          const count = leads.filter((l) => l.estado === status).length;
          const badge = document.getElementById(`count-pipeline-${status}`);
          if (badge) badge.textContent = count;
        });
      }

      function switchOracleTab(tab) {
        [
          "list",
          "distributors",
          "pipeline",
          "analytics",
          "network",
          "leaderboard",
        ].forEach((t) => {
          const el = document.getElementById("view-oracle-" + t);
          const btn = document.getElementById("tab-oracle-" + t);
          if (el) el.classList.add("hidden");
          if (btn) {
            // Reset to default style (muted)
            btn.className =
              "px-5 py-2 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-100 border border-transparent transition";
          }
        });

        const activeEl = document.getElementById("view-oracle-" + tab);
        const activeBtn = document.getElementById("tab-oracle-" + tab);

        if (activeEl) {
          activeEl.classList.remove("hidden");
          activeEl.classList.add("animate-fade-in");
        }
        if (activeBtn) {
          // Active style (highlighted)
          activeBtn.className =
            "px-5 py-2 rounded-xl text-xs font-black bg-white text-violet-600 shadow-md border border-slate-100 transform scale-105 transition";
        }

        // Trigger rendering for charts/network when tab is visible
        if (tab === "network" && typeof L !== "undefined") {
          setTimeout(
            () =>
              renderOracleNetwork(
                _oracleLeadsData,
                window._oracleDistributorsData || [],
              ),
            50,
          );
        }
        if (tab === "analytics") {
          setTimeout(() => renderOracleCharts(_oracleLeadsData), 50);
        }
        if (tab === "leaderboard") {
          setTimeout(() => renderRegionalLeaderboard(_oracleLeadsData), 50);
        }
      }

      async function updateOracleLeadStatus(leadId, newStatus) {
        if (!newStatus) return;
        const pass = AUTH_TOKEN || "";

        // Optimistic Update
        const lead = _oracleLeadsData.find((l) => l.id === leadId);
        const oldStatus = lead ? lead.estado : null;
        if (lead) lead.estado = newStatus;

        // Re-render immediately
        renderOracleLeads(_oracleLeadsData);
        renderOraclePipeline(_oracleLeadsData);
        renderOracleCharts(_oracleLeadsData);

        try {
          await fetch(PROXY_URL_ORACLE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "update-lead",
              payload: { id: leadId, estado: newStatus, password: pass },
            }),
          });
        } catch (e) {
          console.error("Update lead error:", e);
          // Rollback if error
          if (lead) lead.estado = oldStatus;
          renderOracleLeads(_oracleLeadsData);
          renderOraclePipeline(_oracleLeadsData);
        }
      }

      function renderRegionalLeaderboard(leads) {
        const grid = document.getElementById("leaderboard-grid");
        grid.innerHTML = "";

        if (!leads || leads.length === 0) {
          grid.innerHTML =
            '<p class="text-sm text-slate-400">Sin datos para generar ranking.</p>';
          return;
        }

        // Agrupar por regi√≥n
        const byRegion = {};
        leads.forEach((lead) => {
          // Limpiar regi√≥n para homogeneizar ("Metropolitana", "RM", etc)
          let r = lead.region ? lead.region.toUpperCase().trim() : "SIN REGI√ìN";
          if (r.includes("METROPOLITANA") || r.includes(" RM") || r === "RM")
            r = "METROPOLITANA";
          if (
            r.includes("VALPARA√çSO") ||
            r.includes("VALPARAISO") ||
            r.includes("VALPO") ||
            r.includes("V REGION")
          )
            r = "VALPARA√çSO";
          if (
            r.includes("BIOB√çO") ||
            r.includes("BIOB") ||
            r.includes("CONCEPCI√ìN")
          )
            r = "BIOB√çO";

          if (!byRegion[r]) {
            byRegion[r] = [];
          }
          byRegion[r].push(lead);
        });

        // Ordenar regiones por cantidad de leads (de mayor a menor)
        const sortedRegions = Object.entries(byRegion).sort(
          (a, b) => b[1].length - a[1].length,
        );

        // Renderizar tarjetas por cada regi√≥n
        sortedRegions.forEach(([region, regionLeads]) => {
          // Ordenar leads de esa regi√≥n por score
          const topLeads = [...regionLeads]
            .sort((a, b) => (b.score || 0) - (a.score || 0))
            .slice(0, 5); // Tramos los top 5

          const titles = {
            METROPOLITANA: "El Gigante de la Capital",
            VALPARA√çSO: "L√≠der de la Costa",
            BIOB√çO: "Potencia Sure√±a",
            "SIN REGI√ìN": "En Expansi√≥n Nacional",
          };

          const title = titles[region] || "L√≠der Regional";

          const leadsHtml = topLeads
            .map(
              (l, idx) => `
                  <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 cursor-pointer border border-transparent hover:border-slate-100 transition" onclick="openLeadCard('${l.id}')">
                      <div class="flex items-center gap-3 w-full overflow-hidden">
                          <span class="text-xs font-black ${idx === 0 ? "text-amber-500" : idx === 1 ? "text-slate-400" : idx === 2 ? "text-orange-400" : "text-slate-300"}">#${idx + 1}</span>
                          <div class="flex flex-col min-w-0 flex-1">
                              <span class="text-xs font-bold text-slate-700 truncate">${l.nombre_empresa || "Empresa Local"}</span>
                              <span class="text-[9px] text-slate-400 truncate">${l.ciudad || l.comuna || "Localidad Desconocida"}</span>
                          </div>
                      </div>
                      <span class="text-xs font-black text-violet-600 bg-violet-50 px-2 py-0.5 rounded ml-2">${l.score || 0}</span>
                  </div>
              `,
            )
            .join("");

          const cardHtml = `
              <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm hover:shadow-md transition">
                  <div class="bg-slate-50 p-4 border-b border-slate-100">
                      <h4 class="text-[10px] font-black tracking-widest text-slate-400 uppercase mb-1">${region}</h4>
                      <p class="text-sm font-bold text-violet-800 flex items-center gap-2">üëë ${title}</p>
                      <p class="text-[10px] text-slate-500 mt-1">${regionLeads.length} Instaladores Detectados</p>
                  </div>
                  <div class="p-2 space-y-1">
                      ${leadsHtml}
                  </div>
              </div>
              `;
          grid.insertAdjacentHTML("beforeend", cardHtml);
        });
      }

      // ‚îÄ‚îÄ‚îÄ #8 CHARTS ‚Äî Evolution & Distribution ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let chartTimelineInstance = null;
      let chartDistInstance = null;

      function renderOracleCharts(leads) {
        // Chart 1: Timeline (Last 30 days)
        const ctx1 = document.getElementById("chart-leads-timeline");
        if (ctx1) {
          const days = 15;
          const labels = Array.from({ length: days }, (_, i) => {
            const d = new Date();
            d.setDate(d.getDate() - (days - 1 - i));
            return d.toLocaleDateString("es-CL", {
              day: "numeric",
              month: "short",
            });
          });
          const data = labels.map((_, i) => {
            const d = new Date();
            d.setDate(d.getDate() - (days - 1 - i));
            const key = d.toLocaleDateString("en-CA");
            return leads.filter((l) => l.detectado_en?.startsWith(key)).length;
          });

          if (chartTimelineInstance) chartTimelineInstance.destroy();
          chartTimelineInstance = new Chart(ctx1, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Leads Detectados",
                  data: data,
                  borderColor: "#7c3aed",
                  backgroundColor: "rgba(124, 58, 237, 0.1)",
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
            },
          });
        }

        // Chart 2: Score Distribution
        const ctx2 = document.getElementById("chart-scores-dist");
        if (ctx2) {
          const low = leads.filter((l) => l.score < 40).length;
          const mid = leads.filter((l) => l.score >= 40 && l.score < 70).length;
          const high = leads.filter((l) => l.score >= 70).length;

          if (chartDistInstance) chartDistInstance.destroy();
          chartDistInstance = new Chart(ctx2, {
            type: "doughnut",
            data: {
              labels: ["Bajo (<40)", "Medio (40-70)", "Alto (>70)"],
              datasets: [
                {
                  data: [low, mid, high],
                  backgroundColor: ["#cbd5e1", "#f59e0b", "#10b981"],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "70%",
            },
          });
        }
      }

      // ‚îÄ‚îÄ‚îÄ AUXILIARY: TABS & MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      function showOracleModal(leadId) {
        const lead = _oracleLeadsData.find((l) => l.id === leadId);
        if (!lead) return;

        document.getElementById("modal-lead-name").textContent =
          lead.nombre_empresa;
        document.getElementById("modal-lead-meta").textContent =
          `${lead.ciudad || "Chile"} ¬∑ Detectado ${timeAgo(lead.detectado_en)}`;
        document.getElementById("modal-lead-score").textContent = lead.score;
        // Update other fields as needed

        document.getElementById("oracle-lead-modal").classList.remove("hidden");
      }

      function closeOracleModal() {
        document.getElementById("oracle-lead-modal").classList.add("hidden");
      }

      async function forceScan() {
        const btn = document.getElementById("oracle-scan-btn");
        const icon = document.getElementById("oracle-scan-icon");
        const label = document.getElementById("oracle-scan-label");

        btn.disabled = true;
        btn.classList.add("opacity-70", "cursor-not-allowed");

        // Snapshot de leads actuales para detectar cambios
        const prevCount = _oracleLeadsData.length;

        // FIRE AND FORGET ‚Äî no esperamos la respuesta (tarda ~50s)
        // El navegador no hace timeout porque no bloqueamos el hilo
        fetch(ORACLE_BRAIN_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ manual: true }),
        }).catch(() => {}); // ignorar error de timeout del fetch

        // Animaci√≥n de progreso mientras el agente trabaja
        const steps = [
          {
            t: 0,
            icon: "üîç",
            msg: "Buscando empresas instaladoras en Google...",
          },
          { t: 10, icon: "üß†", msg: "Gemini analizando y puntuando leads..." },
          {
            t: 25,
            icon: "‚ö°",
            msg: "Monitoreando tarifas de distribuidoras...",
          },
          {
            t: 40,
            icon: "üíæ",
            msg: "Guardando resultados en base de datos...",
          },
          { t: 55, icon: "‚úÖ", msg: "Finalizando escaneo..." },
        ];

        let elapsed = 0;
        let stepIdx = 0;
        let dataLoaded = false;

        // Mostrar primer paso inmediatamente
        icon.textContent = steps[0].icon;
        label.textContent = steps[0].msg;

        const progressInterval = setInterval(() => {
          elapsed += 1;

          // Avanzar al siguiente mensaje seg√∫n tiempo
          if (stepIdx < steps.length - 1 && elapsed >= steps[stepIdx + 1].t) {
            stepIdx++;
            icon.textContent = steps[stepIdx].icon;
            label.textContent = steps[stepIdx].msg;
          }
        }, 4000);

        // Polling: revisar si llegaron datos nuevos cada 8 segundos
        const pollInterval = setInterval(async () => {
          try {
            const pass = AUTH_TOKEN || "";
            const resp = await fetch(PROXY_URL_ORACLE, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "get-oracle-leads",
                payload: { password: pass },
              }),
            });
            const result = await resp.json();
            if (result.success && result.data) {
              const newCount = result.data.length;
              if (newCount > prevCount || elapsed > 55) {
                // ¬°Llegaron datos nuevos!
                dataLoaded = true;
                clearInterval(pollInterval);
                clearInterval(progressInterval);

                _oracleLeadsData = result.data;
                renderOracleLeads(_oracleLeadsData);
                updateOracleKPIs(
                  _oracleLeadsData,
                  window._oracleDistributorsData || [],
                  _oracleLeadsData.length,
                );
                document.getElementById("sidebar-oracle-count").textContent =
                  _oracleLeadsData.filter((l) => l.estado === "Nuevo").length;

                // Cargar tambi√©n distribuidoras y log
                loadOracleData();

                const nuevos = newCount - prevCount;
                icon.textContent = "‚úÖ";
                label.textContent =
                  nuevos > 0
                    ? `¬°Listo! ${nuevos} nuevos leads encontrados`
                    : "Escaneo completado ‚Äî datos actualizados";

                setTimeout(() => {
                  btn.disabled = false;
                  btn.classList.remove("opacity-70", "cursor-not-allowed");
                  icon.textContent = "‚ö°";
                  label.textContent = "Forzar Escaneo Manual";
                }, 5000);
              }
            }
          } catch (_) {}
        }, 8000);

        // Timeout m√°ximo de 90 segundos
        setTimeout(() => {
          clearInterval(progressInterval);
          clearInterval(pollInterval);
          if (!dataLoaded) {
            icon.textContent = "üîÑ";
            label.textContent = "Escaneo en curso ‚Äî recarga en unos segundos";
            loadOracleData(); // intentar cargar de todas formas
          }
          setTimeout(() => {
            btn.disabled = false;
            btn.classList.remove("opacity-70", "cursor-not-allowed");
            icon.textContent = "‚ö°";
            label.textContent = "Forzar Escaneo Manual";
          }, 4000);
        }, 90000);
      }

      // ‚îÄ‚îÄ‚îÄ #6 RED SOLAR (GEO) ‚Äî Leaflet Map Visualization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let _oracleMap = null;
      let _oracleMapMarkers = [];

      // Coordenadas aproximadas (Latitud, Longitud)
      const CHILE_CITIES = {
        Arica: { lat: -18.47, lon: -70.31 },
        Iquique: { lat: -20.23, lon: -70.14 },
        Antofagasta: { lat: -23.65, lon: -70.39 },
        Calama: { lat: -22.45, lon: -68.93 },
        Copiap√≥: { lat: -27.36, lon: -70.33 },
        "La Serena": { lat: -29.9, lon: -71.25 },
        Coquimbo: { lat: -29.95, lon: -71.34 },
        Valpara√≠so: { lat: -33.04, lon: -71.62 },
        "Vi√±a del Mar": { lat: -33.02, lon: -71.55 },
        Santiago: { lat: -33.44, lon: -70.66 },
        Rancagua: { lat: -34.17, lon: -70.74 },
        Talca: { lat: -35.42, lon: -71.65 },
        Chill√°n: { lat: -36.6, lon: -72.1 },
        Concepci√≥n: { lat: -36.82, lon: -73.04 },
        Temuco: { lat: -38.73, lon: -72.59 },
        Valdivia: { lat: -39.81, lon: -73.24 },
        "Puerto Montt": { lat: -41.46, lon: -72.94 },
        Coyhaique: { lat: -45.57, lon: -72.06 },
        "Punta Arenas": { lat: -53.16, lon: -70.91 },
      };
      const SANTIAGO_DEFAULT = { lat: -33.44, lon: -70.66 };

      // Ubicaciones de Facturaci√≥n Distribuidoras (Aprox)
      const DISTRIBUTOR_LOCATIONS = {
        CGE: { lat: -33.45, lon: -70.58 }, // Stgo
        Enel: { lat: -33.43, lon: -70.64 }, // Stgo
        Chilquinta: { lat: -33.04, lon: -71.61 }, // Valpo
        Saesa: { lat: -41.47, lon: -72.93 }, // Pto Montt
        Frontel: { lat: -38.74, lon: -72.58 }, // Temuco
        Transelec: { lat: -33.4, lon: -70.6 },
        Coelcha: { lat: -36.6, lon: -72.08 },
      };

      function renderOracleNetwork(leads, distributors = []) {
        const container = document.getElementById("oracle-map");
        const view = document.getElementById("view-oracle-network");
        if (!container || !view || view.classList.contains("hidden")) return;

        // Fallback if empty and window has data
        if (
          distributors.length === 0 &&
          window._oracleDistributorsData &&
          window._oracleDistributorsData.length > 0
        ) {
          distributors = window._oracleDistributorsData;
        }

        if (!_oracleMap) {
          // Init Map (Light Mode Center)
          _oracleMap = L.map("oracle-map", {
            center: [-33.44, -70.66],
            zoom: 4,
            zoomControl: false,
            attributionControl: false,
          });

          // CartoDB Positron Tiles (Light, Clean, Tech)
          L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
            {
              attribution:
                '&copy; <a href="https://carto.com/attributions">CARTO</a>',
              subdomains: "abcd",
              maxZoom: 19,
            },
          ).addTo(_oracleMap);

          L.control.zoom({ position: "bottomright" }).addTo(_oracleMap);
        } else {
          setTimeout(() => _oracleMap.invalidateSize(), 100);
        }

        // Clear markers
        _oracleMapMarkers.forEach((m) => _oracleMap.removeLayer(m));
        _oracleMapMarkers = [];

        // 1. Render Distributors (Square Markers)
        // If distributors array is empty, we might want to scan leads for distributor names
        // or just use known locations if we have the list.
        // Assuming distributors array contains objects with 'nombre'
        const usedDistLocs = new Set();
        distributors.forEach((d) => {
          // Try to match name to known location
          const name = d.nombre || "";
          const match = Object.keys(DISTRIBUTOR_LOCATIONS).find((k) =>
            name.includes(k),
          );
          const loc = match ? DISTRIBUTOR_LOCATIONS[match] : null;

          if (loc) {
            // Prevent exact overlap if multiple entities map to same HQ
            let lat = loc.lat;
            let lon = loc.lon;
            if (usedDistLocs.has(name)) {
              // simple jitter if same distributor twice? unlikely but safe
              lat += (Math.random() - 0.5) * 0.01;
              lon += (Math.random() - 0.5) * 0.01;
            }
            usedDistLocs.add(name);

            const distMarker = L.circleMarker([lat, lon], {
              radius: 8,
              fillColor: "#6366f1", // Indigo
              color: "#fff",
              weight: 2,
              opacity: 1,
              fillOpacity: 1,
            }).addTo(_oracleMap);

            distMarker.bindPopup(`
                        <div class="font-sans text-xs p-1">
                            <strong class="block text-indigo-700 text-sm mb-1">‚ö° ${d.nombre}</strong>
                            <div class="text-slate-500 text-[10px]">Tarifa BT1: ${d.tarifa_bt1_actual || "‚Äî"}</div>
                            <div class="text-slate-400 text-[9px] mt-1">Estado: ${d.status_scan}</div>
                        </div>
                    `);
            _oracleMapMarkers.push(distMarker);
          }
        });

        // 2. Render Leads (Circle Markers)
        leads.forEach((l) => {
          let lat = SANTIAGO_DEFAULT.lat;
          let lon = SANTIAGO_DEFAULT.lon;
          let isSantiago = false;

          if (l.ciudad) {
            const c = Object.keys(CHILE_CITIES).find((key) =>
              l.ciudad.toLowerCase().includes(key.toLowerCase()),
            );
            if (c) {
              lat = CHILE_CITIES[c].lat;
              lon = CHILE_CITIES[c].lon;
              if (c === "Santiago") isSantiago = true;
            }
          }

          // Add jitter (randomness) to avoid exact overlap
          const spread = isSantiago ? 0.08 : 0.02;
          lat += (Math.random() - 0.5) * spread;
          lon += (Math.random() - 0.5) * spread;

          const color =
            l.score >= 70 ? "#10b981" : l.score >= 40 ? "#f59e0b" : "#94a3b8";

          const marker = L.circleMarker([lat, lon], {
            radius: l.score >= 70 ? 6 : 4,
            fillColor: color,
            color: "#fff",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.9,
          }).addTo(_oracleMap);

          marker.bindPopup(`
                    <div class="font-sans text-xs p-1">
                        <strong class="block text-slate-800 text-sm mb-1">${l.nombre_empresa}</strong>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-black ${l.score >= 70 ? "bg-emerald-100 text-emerald-700" : "bg-slate-100 text-slate-500"}">SCORE ${l.score}</span>
                            <span class="text-[10px] text-slate-400 uppercase tracking-wide">${l.estado}</span>
                        </div>
                        <div class="text-slate-500 text-[10px]">üìç ${l.ciudad || "Chile"}</div>
                    </div>
                `);

          _oracleMapMarkers.push(marker);
        });

        // 3. Render Neural Connections (Leads -> Nearest Distributor)
        const connectionsLayer = L.layerGroup().addTo(_oracleMap);
        leads.forEach((l) => {
          let leadLat = SANTIAGO_DEFAULT.lat;
          let leadLon = SANTIAGO_DEFAULT.lon;
          if (l.ciudad) {
            const c = Object.keys(CHILE_CITIES).find((key) =>
              l.ciudad.toLowerCase().includes(key.toLowerCase()),
            );
            if (c) {
              leadLat = CHILE_CITIES[c].lat;
              leadLon = CHILE_CITIES[c].lon;
            }
          }

          let nearestDist = null;
          let minDist = Infinity;

          distributors.forEach((d) => {
            const name = d.nombre || "";
            const match = Object.keys(DISTRIBUTOR_LOCATIONS).find((k) =>
              name.includes(k),
            );
            const loc = match ? DISTRIBUTOR_LOCATIONS[match] : null;
            if (loc) {
              const dist = Math.sqrt(
                Math.pow(leadLat - loc.lat, 2) + Math.pow(leadLon - loc.lon, 2),
              );
              if (dist < minDist) {
                minDist = dist;
                nearestDist = loc;
              }
            }
          });

          if (nearestDist && minDist < 3.0) {
            const line = L.polyline(
              [
                [leadLat, leadLon],
                [nearestDist.lat, nearestDist.lon],
              ],
              {
                color: "#94a3b8",
                weight: 0.5,
                opacity: 0.3,
                dashArray: "4, 4",
              },
            ).addTo(connectionsLayer);
            _oracleMapMarkers.push(line);
          }
        });
      }

      function timeAgo(dateStr) {
        const diff = Date.now() - new Date(dateStr).getTime();
        const mins = Math.floor(diff / 60000);
        if (mins < 60) return `hace ${mins}m`;
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return `hace ${hrs}h`;
        return `hace ${Math.floor(hrs / 24)}d`;
      }

      // --- INIT ---
      window.onload = () => {
        const d = new Date();
        document.getElementById("current-date").innerText =
          d.toLocaleDateString("es-CL", {
            day: "numeric",
            month: "long",
            year: "numeric",
          });
      };

      // ‚îÄ‚îÄ‚îÄ #13 LEAD INTELLIGENCE CARD (SLIDE-OVER) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let currentLeadId = null;

      function openLeadCard(leadId) {
        const lead = _oracleLeadsData.find((l) => l.id === leadId);
        if (!lead) return;
        currentLeadId = leadId;

        // Populate static data
        document.getElementById("card-lead-name").innerText =
          lead.nombre_empresa || "Empresa Sin Nombre";
        document.getElementById("card-lead-score").innerText = lead.score || 0;

        let hostname = "‚Äî";
        if (lead.website) {
          try {
            let urlStr = lead.website;
            if (!urlStr.startsWith("http")) urlStr = "https://" + urlStr;
            hostname = new URL(urlStr).hostname;
          } catch (e) {
            hostname = lead.website;
          }
        }
        document.getElementById("card-lead-site").innerText = hostname;
        document.getElementById("card-lead-site").href = lead.website
          ? lead.website.startsWith("http")
            ? lead.website
            : "https://" + lead.website
          : "#";

        // Calculate Loss P4
        const score = lead.score || 0;
        let baseLoss = 500000; // default for low score
        if (score >= 80) baseLoss = 3200000;
        else if (score >= 60) baseLoss = 1800000;
        else if (score >= 40) baseLoss = 950000;

        // Add some random noise for realism but keep it deterministic based on ID
        const deterministicNoise = lead.id.charCodeAt(0) * 10000 || 50000;
        const finalLoss = baseLoss + deterministicNoise;

        document.getElementById("card-loss-value").innerText =
          new Intl.NumberFormat("es-CL", {
            style: "currency",
            currency: "CLP",
            maximumFractionDigits: 0,
          }).format(finalLoss);

        // Populate Inputs
        document.getElementById("card-lead-email").value = lead.email || "";
        document.getElementById("card-lead-phone").value = lead.telefono || "";
        document.getElementById("card-lead-city").value = lead.ciudad || "";

        // Reset Enrichment Section
        const enrichContainer = document.getElementById("card-enrichment-data");
        const deepScanBtn = document.getElementById("btn-deep-scan");

        if (
          lead.enrichment_data &&
          Object.keys(lead.enrichment_data).length > 0
        ) {
          renderEnrichmentData(lead.enrichment_data);
          deepScanBtn.classList.add("hidden");
        } else {
          enrichContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="inline-block p-4 bg-slate-50 rounded-full mb-3 text-2xl">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
                        <p class="text-sm font-bold text-slate-600">Sin datos de inteligencia</p>
                        <p class="text-xs text-slate-400 mb-4">Ejecuta un Deep Scan para analizar su web.</p>
                    </div>`;
          deepScanBtn.classList.remove("hidden");

          // Auto-trigger if NEW and valid URL
          if (lead.estado === "Nuevo" && lead.website && !lead._scanFailed) {
            triggerDeepScan();
          }
        }

        // Show Slide-over
        const overlay = document.getElementById("lead-card-overlay");
        const panel = document.getElementById("lead-card-panel");
        overlay.classList.remove("hidden");
        // Small delay for CSS transition
        setTimeout(() => {
          overlay.classList.remove("opacity-0");
          panel.classList.remove("translate-x-full");
        }, 10);
      }

      async function updateOracleContactField(field, value) {
        if (!currentLeadId) return;
        const lead = _oracleLeadsData.find((l) => l.id === currentLeadId);
        if (!lead) return;

        // Optimistic update locally
        lead[field] = value;

        // Auto check WhatsApp button if phone updated
        if (field === "telefono") {
          // optional: reformat logic
        }

        try {
          const pass = AUTH_TOKEN || "";
          const payload = { id: currentLeadId, password: pass };
          payload[field] = value;

          // Call update-lead action
          await fetch(PROXY_URL_ORACLE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "update-lead", payload: payload }),
          });
          console.log(`Updated ${field}: ${value}`);
        } catch (e) {
          console.error("Update failed", e);
          // Simple visual feedback could be added here (e.g. red border)
        }
      }

      function openWhatsApp() {
        const phoneInput = document.getElementById("card-lead-phone");
        let phone = phoneInput.value.replace(/\D/g, ""); // remove non-digits
        if (!phone) {
          alert("Ingresa un tel√©fono primero");
          return;
        }
        // Assume Chile if no country code, add 56
        if (
          phone.length === 9 &&
          (phone.startsWith("9") || phone.startsWith("2"))
        ) {
          phone = "56" + phone;
        }
        window.open(`https://wa.me/${phone}`, "_blank");
      }

      function closeLeadCard() {
        const overlay = document.getElementById("lead-card-overlay");
        const panel = document.getElementById("lead-card-panel");
        overlay.classList.add("opacity-0");
        panel.classList.add("translate-x-full");
        setTimeout(() => {
          overlay.classList.add("hidden");
        }, 300);
      }

      async function triggerDeepScan() {
        const lead = _oracleLeadsData.find((l) => l.id === currentLeadId);
        if (!lead || !lead.website) return;

        const btn = document.getElementById("btn-deep-scan");
        const container = document.getElementById("card-enrichment-data");

        // UI Loading State
        btn.disabled = true;
        btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analizando ${new URL(lead.website).hostname}...`;

        container.innerHTML = `
                <div class="animate-pulse space-y-3">
                    <div class="h-4 bg-slate-100 rounded w-3/4"></div>
                    <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                    <div class="h-20 bg-slate-100 rounded"></div>
                </div>`;

        try {
          const pass = AUTH_TOKEN || "";
          const resp = await fetch(PROXY_URL_ORACLE, {
            method: "POST", // Reusing the same proxy function
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "enrich-lead",
              payload: { id: lead.id, url: lead.website, password: pass },
            }),
          });

          const result = await resp.json();
          if (result.success && result.data) {
            // Update Local Data
            lead.enrichment_data = result.data;
            renderEnrichmentData(result.data);
            btn.classList.add("hidden"); // Hide button on success
          } else {
            throw new Error(result.error || "Fallo en an√°lisis");
          }
        } catch (err) {
          console.error(err);
          lead._scanFailed = true; // Prevent re-triggering automatically
          btn.innerHTML = "‚ùå Error. Reintentar";
          btn.disabled = false;
          // Show actual error message for debugging
          container.innerHTML = `<div class="text-center p-4 bg-red-50 rounded-xl border border-red-100">
                    <p class="text-xs text-red-600 font-bold mb-1">Fall√≥ el escaneo</p>
                    <p class="text-[10px] text-red-400 font-mono break-words">${err.message}</p>
                </div>`;
        }
      }

      function renderEnrichmentData(data) {
        const container = document.getElementById("card-enrichment-data");
        const stackBadges = (data.stack || [])
          .map(
            (s) =>
              `<span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-[10px] font-bold border border-indigo-100">${s}</span>`,
          )
          .join("");

        const compProfileHtml = data.competitor_profile
          ? `<div class="mt-4 p-3 bg-indigo-50 border border-indigo-100 rounded-lg">
                <h5 class="text-[10px] font-black text-indigo-800 uppercase tracking-widest mb-1 flex items-center gap-1"><span class="text-[14px]">üíº</span> Radiograf√≠a B2B</h5>
                <p class="text-xs text-slate-700 leading-relaxed">${data.competitor_profile}</p>
            </div>`
          : "";

        const outreachDraftHtml = data.outreach_draft
          ? `<div class="mt-4 p-3 bg-emerald-50 border border-emerald-100 rounded-lg group relative">
                <div class="flex items-center justify-between mb-2">
                    <h5 class="text-[10px] font-black text-emerald-800 uppercase tracking-widest flex items-center gap-1"><span class="text-[14px]">ü§ñ</span> Borrador Auto-Outreach</h5>
                    <button onclick="navigator.clipboard.writeText(document.getElementById('ai-outreach-text').value); this.innerText='‚úì Copiado'" class="text-[9px] bg-white border border-emerald-200 text-emerald-700 font-bold px-2 py-1 rounded shadow-sm hover:bg-emerald-100 transition">Copiar Mensaje</button>
                </div>
                <textarea id="ai-outreach-text" class="w-full text-xs text-slate-700 h-28 bg-white/50 rounded p-2 resize-none outline-none border border-emerald-100 focus:border-emerald-300 font-medium">${data.outreach_draft}</textarea>
             </div>`
          : "";

        container.innerHTML = `
                <div class="bg-violet-50/50 rounded-xl p-4 border border-violet-100 mb-4 shadow-sm">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-lg animate-pulse">‚ú®</span>
                        <h4 class="text-xs font-black text-violet-800 uppercase tracking-widest">An√°lisis Oracle IA</h4>
                    </div>
                    <p class="text-xs text-slate-600 leading-relaxed mb-3">${data.ai_summary || "An√°lisis completado."}</p>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-white p-2 rounded border border-violet-100 shadow-sm">
                            <span class="block text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Tipo Empresa</span>
                            <span class="font-bold text-slate-700">${data.type}</span>
                        </div>
                        <div class="bg-white p-2 rounded border border-violet-100 shadow-sm">
                            <span class="block text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Tama√±o</span>
                            <span class="font-bold text-slate-700">${data.size}</span>
                        </div>
                    </div>
                    ${compProfileHtml}
                    ${outreachDraftHtml}
                </div>

                <div class="mb-5">
                    <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span> Tech Stack Detectado</h5>
                    <div class="flex flex-wrap gap-2">
                        ${stackBadges || '<span class="text-xs text-slate-400 italic">No se detectaron marcas conocidas.</span>'}
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <a href="#" class="flex items-center gap-2 p-2 rounded-lg border ${data.social?.linkedin ? "border-blue-200 bg-blue-50 text-blue-700" : "border-slate-100 text-slate-400"}">
                        <span class="text-sm">üíº</span> <span class="text-xs font-bold">LinkedIn</span>
                        ${data.social?.linkedin ? "‚úÖ" : ""}
                        </span>
                        <span>LinkedIn</span>
                    </a>
                    <a href="#" class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl text-xs font-bold text-slate-500 hover:bg-pink-50 hover:text-pink-600 transition ${data.social?.instagram ? "bg-pink-50 text-pink-600" : "opacity-50"}">
                        <span class="w-4 h-4 flex items-center justify-center rounded-full bg-white shadow-sm text-[10px]">
                            ${data.social?.instagram ? "‚úÖ" : ""}
                        </span>
                        <span>Instagram</span>
                    </a>
                </div>
            </div>

            ${
              data.contact_suggestion &&
              (data.contact_suggestion.email ||
                (data.contact_suggestion.phones &&
                  data.contact_suggestion.phones.length > 0))
                ? `
            <div class="mt-4 p-4 bg-amber-50 rounded-xl border border-amber-100">
                <h4 class="text-[10px] font-black uppercase text-amber-500 mb-2">üïµÔ∏è‚Äç‚ôÇÔ∏è Datos P√∫blicos Detectados</h4>
                <div class="space-y-1">
                    ${
                      data.contact_suggestion.email
                        ? `
                    <div class="flex justify-between items-center group">
                        <span class="text-xs text-slate-600 font-mono">${data.contact_suggestion.email}</span>
                        <button onclick="updateOracleContactField('email', '${data.contact_suggestion.email}')" class="text-[10px] bg-white border border-amber-200 text-amber-600 px-2 py-0.5 rounded shadow-sm hover:bg-amber-100 opacity-0 group-hover:opacity-100 transition">Usar</button>
                    </div>`
                        : ""
                    }
                    ${
                      data.contact_suggestion.phones
                        ? data.contact_suggestion.phones
                            .map(
                              (p) => `
                    <div class="flex justify-between items-center group py-0.5">
                        <div class="flex flex-col">
                            <span class="text-xs text-slate-700 font-mono font-bold">${p.number}</span>
                            <span class="text-[9px] text-slate-400 italic leading-tight">${p.context || ""}</span>
                        </div>
                         <button onclick="updateOracleContactField('telefono', '${p.number}')" class="text-[10px] bg-white border border-amber-200 text-amber-600 px-2 py-0.5 rounded shadow-sm hover:bg-amber-100 opacity-0 group-hover:opacity-100 transition h-fit">Usar</button>
                    </div>`,
                            )
                            .join("")
                        : ""
                    }
                </div>
            </div>`
                : ""
            }`;
      }
      async function clearOracleLogs() {
        if (
          !confirm("¬øSeguro que quieres borrar todo el historial de escaneos?")
        )
          return;
        try {
          const pass = AUTH_TOKEN || "solar2026";
          const resp = await fetch(PROXY_URL_ORACLE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "clear-scan-logs",
              payload: { password: pass },
            }),
          });
          const res = await resp.json();
          if (res.success) {
            renderScanLog([]);
          }
        } catch (e) {
          console.error(e);
        }
      }
    </script>
  </body>
</html>
