<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Oracle Admin | Nexos Corp</title>
    <!-- Removed Supabase SDK: using Secure Proxy -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .status-ghost {
            background: #334155;
            color: #94a3b8;
        }

        .status-lead {
            background: #065f46;
            color: #34d399;
        }
    </style>
</head>

<body class="p-8 relative">

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-96 border border-slate-700">
            <h2 class="text-xl font-bold text-white mb-6 text-center">游댏 Acceso Seguro</h2>
            <input type="password" id="admin-pass" placeholder="Contrase침a Maestra"
                class="w-full bg-slate-700 border border-slate-600 rounded p-3 text-white mb-4 focus:outline-none focus:border-amber-500"
                onkeydown="if(event.key==='Enter') verifyLogin()">
            <button onclick="verifyLogin()"
                class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded transition">
                Ingresar
            </button>
            <p id="login-error" class="text-red-400 text-sm mt-3 text-center hidden">Contrase침a incorrecta</p>
        </div>
    </div>

    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-white tracking-widest">SOLAR<span class="text-amber-500">ORACLE</span> <span
                class="text-xs text-slate-500 font-normal">ADMIN V1.0</span></h1>
        <div class="flex gap-4">
            <button onclick="fetchLeads()"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-medium transition">游댃 Refrescar
                Datos</button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="glass-panel p-6">
            <div class="text-slate-400 text-sm uppercase font-semibold">Total Registros</div>
            <div class="text-4xl font-bold text-white mt-2" id="kpi-total">0</div>
        </div>
        <div class="glass-panel p-6">
            <div class="text-slate-400 text-sm uppercase font-semibold">Leads Reales</div>
            <div class="text-4xl font-bold text-green-400 mt-2" id="kpi-leads">0</div>
        </div>
        <div class="glass-panel p-6">
            <div class="text-slate-400 text-sm uppercase font-semibold">Ghosts (Abandonos)</div>
            <div class="text-4xl font-bold text-slate-400 mt-2" id="kpi-ghosts">0</div>
        </div>
        <div class="glass-panel p-6">
            <div class="text-slate-400 text-sm uppercase font-semibold">Tasa Conversi칩n</div>
            <div class="text-4xl font-bold text-amber-500 mt-2" id="kpi-rate">0%</div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="glass-panel overflow-hidden">
        <div class="p-4 border-b border-slate-700 flex justify-between items-center">
            <h3 class="font-semibold text-lg">Base de Datos de Factibilidad</h3>
            <span class="text-xs text-slate-500" id="last-updated">Actualizado: Nunca</span>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="text-xs text-slate-400 uppercase bg-slate-800/50">
                    <tr>
                        <th class="px-6 py-3">Ticket ID</th>
                        <th class="px-6 py-3">Fecha</th>
                        <th class="px-6 py-3">Estado</th>
                        <th class="px-6 py-3">Cliente</th>
                        <th class="px-6 py-3">Ubicaci칩n</th> <!-- New Column -->
                        <th class="px-6 py-3">Contacto</th>
                        <th class="px-6 py-3">Distribuidora</th>
                        <th class="px-6 py-3 text-right">Consumo</th>
                        <th class="px-6 py-3 text-right">Ahorro Est.</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-700">
                    <!-- Rows will be injected here -->
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-slate-500">Cargando datos de la nube...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- SECURE PROXY CONFIG ---
        const PROXY_URL = 'https://zqwkwnywndkwyzzggorf.supabase.co/functions/v1/save-lead';
        let AUTH_TOKEN = null; // We store the password here temporarily in memory

        function verifyLogin() {
            const pass = document.getElementById('admin-pass').value;
            if (!pass) return;
            AUTH_TOKEN = pass;
            document.getElementById('login-modal').classList.add('hidden');
            fetchLeads();
        }

        async function fetchLeads() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-slate-500">Autenticando y descargando datos seguros...</td></tr>`;

            try {
                // 1. Fetch Data via Proxy
                const resp = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get-leads',
                        payload: { password: AUTH_TOKEN }
                    })
                });

                if (resp.status === 401) {
                    document.getElementById('login-modal').classList.remove('hidden');
                    document.getElementById('login-error').classList.remove('hidden');
                    throw new Error("Contrase침a incorrecta");
                }

                const result = await resp.json();
                if (!result.success) throw new Error(result.error || 'Error desconocido');

                const data = result.data || [];

                // 2. Update KPIs
                const total = data.length;
                const leads = data.filter(r => r.tipo === 'LEAD').length;
                const ghosts = total - leads;
                const rate = total > 0 ? ((leads / total) * 100).toFixed(1) : 0;

                document.getElementById('kpi-total').innerText = total;
                document.getElementById('kpi-leads').innerText = leads;
                document.getElementById('kpi-ghosts').innerText = ghosts;
                document.getElementById('kpi-rate').innerText = rate + '%';

                // 3. Render Table
                tbody.innerHTML = '';
                if (total === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-8 text-center text-slate-500">A칰n no hay registros en la base de datos.</td></tr>`;
                    return;
                }

                data.forEach(row => {
                    const isLead = row.tipo === 'LEAD';
                    const badgeClass = isLead ? 'bg-green-900 text-green-300' : 'bg-slate-700 text-slate-300';
                    const date = new Date(row.created_at).toLocaleString('es-CL');
                    const ticketId = row.id ? row.id.substring(0, 8).toUpperCase() : '???';

                    const isWhale = (parseInt(row.kwh_mensual) || 0) > 600;
                    const whaleClass = isWhale ? 'bg-indigo-900/40 border-l-4 border-l-indigo-500' : '';
                    
                    // WhatsApp Logic
                    let waBtn = '';
                    if (row.telefono) {
                        const cleanPhone = row.telefono.replace(/\D/g, '');
                        const msg = `Hola ${row.nombre}, vi en SolarOracle que tu consumo es de ${row.kwh_mensual} kWh en ${row.ubicacion || 'tu domicilio'}. Tengo una propuesta para bajar esa cuenta a $0.`;
                        const link = `https://wa.me/569${cleanPhone}?text=${encodeURIComponent(msg)}`;
                        waBtn = `<a href="${link}" target="_blank" class="inline-flex items-center gap-1 mt-1 px-2 py-1 bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold rounded transition">
                                    <span>游눫</span> Contactar
                                 </a>`;
                    }

                    const tr = document.createElement('tr');
                    tr.className = `hover:bg-slate-800/50 transition ${whaleClass}`;
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-mono text-xs text-slate-500">
                            #${ticketId}
                            ${isWhale ? ' <span title="Cliente Alto Valor" class="ml-1">游낾</span>' : ''}
                        </td>
                        <td class="px-6 py-4 text-slate-400 whitespace-nowrap text-xs">${date}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${row.tipo || 'GHOST'}</span>
                            ${(!isLead && (parseInt(row.kwh_mensual)||0) > 300) ? 
                                '<div class="mt-1"><span class="px-2 py-0.5 rounded text-[10px] font-bold bg-amber-900/50 text-amber-200 border border-amber-700/50">游댠 RECUPERABLE</span></div>' 
                                : ''}
                        </td>
                        <td class="px-6 py-4 font-medium text-white">
                            ${row.nombre || 'An칩nimo'}
                            <div class="text-xs text-slate-500">ID: ${row.client_number || '-'}</div>
                        </td>
                        <td class="px-6 py-4 text-slate-300 text-xs">${row.ubicacion || 'N/A'}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">
                            ${row.email || '-'}<br>
                            ${row.telefono || ''}
                            <div class="mt-1">${waBtn}</div>
                        </td>
                        <td class="px-6 py-4 text-slate-300 text-xs">${row.distribuidora || 'General'}</td>
                        <td class="px-6 py-4 text-right text-amber-400 font-mono">
                            ${row.kwh_mensual || 0} kWh
                            ${isWhale ? '<div class="text-[10px] text-indigo-300 font-bold">ALTO VALOR</div>' : ''}
                        </td>
                        <td class="px-6 py-4 text-right text-green-400 font-mono">${row.ahorro_anual || '$0'}</td>
                    `;
                    tbody.appendChild(tr);
                });

                document.getElementById('last-updated').innerText = 'Actualizado: ' + new Date().toLocaleTimeString();

            } catch (err) {
                console.error(err);
                if (err.message !== "Contrase침a incorrecta") {
                    tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-8 text-center text-red-400">Error: ${err.message}</td></tr>`;
                }
            }
        }

        // Init - Focus password input
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('admin-pass').focus();
        });
    </script>
</body>

</html>